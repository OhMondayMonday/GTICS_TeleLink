<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{Superadmin/fragments/head.html :: head(title='Realizar reserva')}">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body data-sidebar="dark" class="vertical-collpsed">
    <div id="layout-wrapper">
        <div th:replace="~{Vecino/fragments/topbarVecino :: topbar('Calendario')}"></div>
        <div th:replace="~{Vecino/fragments/sidebarVecino :: sidebar('Calendario')}"></div>

        <div class="main-content">
            <div class="page-content" style="min-height: 100%;">
                <div class="container-fluid">

                    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                        <span th:text="${error}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>

                    <!-- start page title -->
                    <div class="row">
                        <div class="col-12">
                            <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                                <h4 class="mb-sm-0">Reservar espacio deportivo</h4>
                                <div class="page-title-right">
                                    <a th:href="@{/usuarios/cancha}" class="btn ms-2 btn-outline-primary">
                                        <i class="fas fa-arrow-left me-1"></i> Regresar a espacios
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div><!-- end page title -->
                    <div class="row mb-4">
                        <!-- Detalles del espacio deportivo -->
                        <div class="col-xl-3 col-lg-4">
                            <div class="card">
                                <!-- Foto del establecimiento deportivo -->
                                <div class="position-relative">
                                    <img th:src="${espacio.fotoEspacioDeportivoUrl != null ? espacio.fotoEspacioDeportivoUrl : '/assets/images/canchita.jpg'}"
                                        alt="Establecimiento Deportivo" class="card-img-top"
                                        style="height: 160px; object-fit: cover;">
                                </div>
                                <div class="card-header d-flex justify-content-between align-items-center py-2">
                                    <h4 class="card-title mb-0 fw-bold py-1" th:text="${espacio.nombre}">Espacio
                                        Deportivo</h4>
                                    <button class="btn btn-link p-0 text-primary" data-bs-toggle="tooltip"
                                        data-bs-placement="left" data-bs-trigger="click" data-bs-html="true"
                                        th:attr="data-bs-title='<div class=&quot;text-start&quot;><strong>Informaci√≥n de reservas:</strong><br>‚Ä¢ Haz clic en un horario disponible para reservar<br>‚Ä¢ Las reservas deben ser confirmadas<br>‚Ä¢ Cancela con 2 horas de anticipaci√≥n<br>‚Ä¢ M√°ximo 2 horas por reserva</div>'">
                                        <i class="fas fa-info-circle fs-4"></i>
                                    </button>
                                </div>
                                <div class="card-body py-4">
                                    <div class="space-details">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-muted">Capacidad:</span>
                                            <span class="fw-medium">
                                                <i class="fas fa-users text-info me-2"></i>
                                                <span th:text="${espacio.aforoGimnasio != null ? espacio.aforoGimnasio : 
                                                                     (espacio.maxPersonasPorCarril != null ? espacio.maxPersonasPorCarril + ' por carril' : 
                                                                      '22')}">22</span>
                                            </span>
                                        </div>

                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-muted">Precio por hora:</span>
                                            <span class="text-success fw-bold">
                                                <i class="fas fa-dollar-sign me-2"></i>
                                                S/. <span
                                                    th:text="${espacio.precioPorHora != null ? espacio.precioPorHora : '50.00'}">50.00</span>
                                            </span>
                                        </div>

                                        <div class="d-flex justify-content-between align-items-center mb-2" |>
                                            <span class="text-muted">Horario:</span>
                                            <span>
                                                <i class="fas fa-clock text-warning me-2"></i>
                                                <span th:text="${espacio.horarioApertura != null && espacio.horarioCierre != null ? 
                                                                     #temporals.format(espacio.horarioApertura, 'HH:mm') + ' - ' + #temporals.format(espacio.horarioCierre, 'HH:mm') : 
                                                                     '7:00 - 22:00'}">7:00 - 22:00</span>
                                            </span>
                                        </div>

                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-muted">Estado:</span>
                                            <span>
                                                <span class="badge bg-success-subtle text-success"
                                                    th:if="${espacio.estadoServicio.name() == 'operativo'}">
                                                    <i class="fas fa-check-circle me-1"></i>Disponible
                                                </span>
                                                <span class="badge bg-warning-subtle text-warning"
                                                    th:if="${espacio.estadoServicio.name() == 'mantenimiento'}">
                                                    <i class="fas fa-tools me-1"></i>Mantenimiento
                                                </span>
                                                <span class="badge bg-danger-subtle text-danger"
                                                    th:if="${espacio.estadoServicio.name() == 'clausurado'}">
                                                    <i class="fas fa-times-circle me-1"></i>Clausurado
                                                </span>
                                            </span>
                                        </div>
                                        <div th:if="${espacio.descripcion}" class="mb-3 pb-3 border-bottom">
                                            <div class="d-flex align-items-start mb-2">
                                                <i class="fas fa-info-circle text-primary me-2 mt-1"></i>
                                                <span class="text-muted fw-medium">Descripci√≥n</span>
                                            </div>
                                            <p th:text="${espacio.descripcion}"
                                                class="text-secondary mb-0 lh-base ps-4">Descripci√≥n del espacio...</p>
                                        </div>

                                        <div th:if="${espacio.geolocalizacion}" class="mb-0">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                                <span class="text-muted fw-medium">Ubicaci√≥n</span>
                                            </div>
                                            <div class="map-container"
                                                style="height: 150px; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb;">
                                                <!-- Alternativa 1: Si las coordenadas est√°n en formato "lat,lng" -->
                                                <iframe
                                                th:src="@{'https://maps.google.com/maps?q=' + ${espacio.geolocalizacion} + '&z=16&output=embed'}"
                                                width="100%" height="100%" style="border:0;"
                                                allowfullscreen="" loading="lazy"
                                                referrerpolicy="no-referrer-when-downgrade"></iframe>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Calendario -->
                        <div class="col-xl-9 col-lg-8">
                            <div class="card mb-0">
                                <div class="card-body calendar-container">
                                    <!-- En el div del calendario -->
                                    <div id="calendar" style="height: 100%;"
                                        th:attr="data-espacio-id=${espacioId},
              data-horario-apertura=${espacio.horarioApertura != null ? #temporals.format(espacio.horarioApertura, 'HH:mm:ss') : '07:00:00'},
              data-horario-cierre=${espacio.horarioCierre != null ? #temporals.format(espacio.horarioCierre, 'HH:mm:ss') : '22:00:00'}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> <!-- end row-->
                    <div style='clear:both'></div>

                    <!-- Add New Event MODAL -->
                    <div class="modal fade" id="event-modal" data-bs-backdrop="static" data-bs-keyboard="false"
                        tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header py-3 px-4">
                                    <h5 class="modal-title" id="modal-title">Crear Reserva</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body p-4">
                                    <form class="needs-validation" name="event-form" id="form-event" novalidate
                                        th:action="@{/usuarios/crear-reserva-calendario}" method="post">
                                        <input type="hidden" name="title" id="event-title" value="Reservado">
                                        <input type="hidden" name="reservaId" id="reserva-id">
                                        <input type="hidden" name="espacioId" id="input-espacio-id">
                                        <input type="hidden" name="fechaInicio" id="input-fecha-inicio">
                                        <input type="hidden" name="fechaFin" id="input-fecha-fin"> <input type="hidden"
                                            name="numeroCarrilPista" id="input-carril-atletismo">
                                        <input type="hidden" name="numeroParticipantes"
                                            id="input-participantes-atletismo">
                                        <div id="create-reservation-form">
                                            <div class="mb-3">
                                                <label class="form-label" for="event-start">Hora de inicio</label>
                                                <input class="form-control" type="text" id="event-start" name="start"
                                                    readonly>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label" for="event-end">Hora de fin</label>
                                                <select class="form-select" id="event-end" name="end" required>
                                                    <option value="" disabled selected>Seleccione hora de fin</option>
                                                    <!-- Opciones generadas din√°micamente con JS -->
                                                </select>
                                                <div class="invalid-feedback">Seleccione una hora de fin v√°lida</div>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label" for="lane-select">Carril</label>
                                                <select class="form-select" id="lane-select" name="lane" required
                                                    disabled>
                                                    <option value="" disabled selected>Primero seleccione la hora de fin
                                                    </option>
                                                    <!-- Opciones generadas din√°micamente con JS -->
                                                </select>
                                                <div class="invalid-feedback">Seleccione un carril disponible</div>
                                                <div class="form-text mt-1" id="lane-info">
                                                    Primero debe seleccionar una hora de fin para ver los carriles
                                                    disponibles.
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label" for="participants-select">N√∫mero de
                                                    participantes</label>
                                                <select class="form-select" id="participants-select" name="participants"
                                                    required disabled>
                                                    <option value="" disabled selected>Primero seleccione un carril
                                                    </option>
                                                    <!-- Opciones generadas din√°micamente con JS -->
                                                </select>
                                                <div class="invalid-feedback">Seleccione el n√∫mero de participantes
                                                </div>
                                                <div class="form-text mt-1" id="participants-info">
                                                    Primero debe seleccionar un carril para ver los espacios
                                                    disponibles.
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Precio estimado</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">S/.</span>
                                                    <input type="text" class="form-control" id="price-display" readonly>
                                                </div>
                                                <div class="form-text mt-1">
                                                    Precio = (Precio por hora √ó Horas) √ó N√∫mero de participantes
                                                </div>
                                            </div>

                                            <div class="row mt-2">
                                                <div class="col-6">
                                                </div>
                                                <div class="col-6 text-end">
                                                    <button type="button" class="btn btn-light me-1"
                                                        data-bs-dismiss="modal">Cerrar</button>
                                                    <button type="submit" class="btn btn-success"
                                                        id="btn-save-event">Crear</button>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="view-reservation-details" style="display: none;">
                                            <div class="mb-3">
                                                <h6>Detalles de tu reserva</h6>
                                                <table class="table table-borderless mb-0">
                                                    <tbody>
                                                        <tr>
                                                            <th scope="row">Inicio:</th>
                                                            <td id="detail-start"></td>
                                                        </tr>
                                                        <tr>
                                                            <th scope="row">Fin:</th>
                                                            <td id="detail-end"></td>
                                                        </tr>
                                                        <tr>
                                                            <th scope="row">Carril:</th>
                                                            <td id="detail-lane"></td>
                                                        </tr>
                                                        <tr>
                                                            <th scope="row">Participantes:</th>
                                                            <td id="detail-participants"></td>
                                                        </tr>
                                                        <tr>
                                                            <th scope="row">Estado:</th>
                                                            <td id="detail-status"></td>
                                                        </tr>
                                                        <tr>
                                                            <th scope="row">Ocupaci√≥n:</th>
                                                            <td id="detail-ocupacion"></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-12 text-end">
                                                    <button type="button" class="btn btn-light"
                                                        data-bs-dismiss="modal">Cerrar</button>
                                                    <a href="#" id="btn-cancel-reservation"
                                                        class="btn btn-danger">Cancelar reserva</a>
                                                    <a href="/usuarios/mis-reservas" class="btn btn-primary">Ver todas
                                                        mis reservas</a>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- end modal-->

                </div>
            </div>

            <div th:replace="~{Superadmin/fragments/footer.html :: footer}"></div>
        </div>
    </div> <!-- Scripts -->
    <div th:replace="~{Superadmin/fragments/foot.html :: foot}"></div>

    <!-- SweetAlert2 para notificaciones de conflictos -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* ===== SOLUCI√ìN PARA TEXTAREA EN SWEETALERT2 ===== */
        .swal2-container .swal2-popup .swal2-html-container {
            overflow: visible !important;
        }

        .swal2-container .swal2-popup .swal2-html-container .form-control {
            pointer-events: auto !important;
            user-select: text !important;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            background-color: #fff !important;
            border: 1px solid #ced4da !important;
            border-radius: 6px !important;
            padding: 8px 12px !important;
            font-size: 14px !important;
            line-height: 1.5 !important;
            color: #495057 !important;
            opacity: 1 !important;
            cursor: text !important;
        }

        .swal2-container .swal2-popup .swal2-html-container .form-control:focus {
            border-color: #80bdff !important;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
            outline: 0 !important;
            background-color: #fff !important;
        }

        .swal2-container .swal2-popup .swal2-html-container .alert {
            border-radius: 8px !important;
            border: 1px solid !important;
            padding: 12px !important;
            margin: 15px 0 !important;
        }

        .swal2-container .swal2-popup .swal2-html-container .alert-info {
            background-color: #e7f3ff !important;
            border-color: #b3d9ff !important;
            color: #004085 !important;
        }

        .swal2-container .swal2-popup .swal2-html-container .alert-success {
            background-color: #d1edff !important;
            border-color: #b3d9ff !important;
            color: #0c5460 !important;
        }

        .swal2-container .swal2-popup .swal2-html-container .alert-warning {
            background-color: #fff3cd !important;
            border-color: #ffeaa7 !important;
            color: #856404 !important;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // =============================
            // VARIABLES GLOBALES
            // =============================
            const modalEl = document.getElementById('event-modal');
            const modal = new bootstrap.Modal(modalEl);
            const modalTitle = document.getElementById('modal-title');
            const form = document.getElementById('form-event');
            const calendarEl = document.getElementById('calendar');

            const espacioId = calendarEl.dataset.espacioId;
            const horarioApertura = calendarEl.dataset.horarioApertura || '07:00:00';
            const horarioCierre = calendarEl.dataset.horarioCierre || '22:00:00';

            let selectedEvent = null;
            let clickInfo = null;
            let calendar = null;

            const now = new Date();

            // =============================
            // VERIFICACI√ìN DE CONFLICTOS INICIALES
            // =============================
            function verificarConflictosIniciales() {
                const conflictoDetectado = /*[[${conflictoDetectado}]]*/ false;
                const mensajeConflicto = /*[[${mensajeConflicto}]]*/ '';

                if (conflictoDetectado && mensajeConflicto) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Conflicto de Reserva',
                        text: mensajeConflicto,
                        confirmButtonText: 'Entendido',
                        confirmButtonColor: '#d33'
                    });
                }
            }

            // =============================
            // CONFIGURACI√ìN DEL CALENDARIO
            // =============================
            function configurarCalendario() {
                const customConfig = {
                    // Clases CSS para eventos
                    eventClassNames: function (arg) {
                        try {
                            const evento = arg.event;
                            const esPropia = evento.extendedProps && evento.extendedProps.esPropia === true;
                            const estado = evento.extendedProps && evento.extendedProps.estado;

                            if (!esPropia) return ['reserva-ajena'];

                            if (estado === 'confirmada') return ['reserva-propia-confirmada'];
                            if (estado === 'pendiente') return ['reserva-propia-pendiente'];
                            if (estado === 'en_proceso') return ['reserva-propia-en-proceso'];

                            return ['reserva-propia-pendiente'];
                        } catch (error) {
                            console.error("Error al asignar clases a evento:", error);
                            return [];
                        }
                    },

                    // Cargar eventos
                    events: function (info, successCallback, failureCallback) {
                        fetch('/api/reservas/atletismo/' + espacioId)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Error al cargar reservas: ' + response.status);
                                }
                                return response.json();
                            })
                            .then(data => {
                                // Procesar todos los eventos (reservas y mantenimientos)
                                const events = data.map(evento => {
                                    // Verificar si es un evento de mantenimiento
                                    if (evento.esMantenimiento === true) {
                                        // Formatear las fechas para mostrar en el t√≠tulo
                                        const fechaInicioOriginal = new Date(evento.start);
                                        const fechaFin = new Date(evento.end);
                                        const ahora = new Date();

                                        // Determinar la fecha de inicio efectiva
                                        let fechaInicio = fechaInicioOriginal;

                                        // Si el mantenimiento est√° en curso y ya empez√≥, usar la hora actual
                                        if (evento.estado && evento.estado.toLowerCase() === 'en_curso' || fechaInicioOriginal < ahora) {
                                            fechaInicio = ahora;
                                        }

                                        // Formatear solo la hora si es el mismo d√≠a, o fecha completa si es diferente d√≠a
                                        let horarioTexto = '';
                                        if (fechaInicioOriginal.toDateString() === fechaFin.toDateString()) {
                                            // Mismo d√≠a - mostrar solo las horas
                                            const horaInicio = fechaInicioOriginal.toLocaleTimeString('es-PE', {
                                                hour: '2-digit',
                                                minute: '2-digit',
                                                hour12: false
                                            });
                                            const horaFin = fechaFin.toLocaleTimeString('es-PE', {
                                                hour: '2-digit',
                                                minute: '2-digit',
                                                hour12: false
                                            });
                                            horarioTexto = `${horaInicio} - ${horaFin}`;
                                        } else {
                                            // Diferentes d√≠as - mostrar fecha y hora
                                            const inicioCompleto = fechaInicioOriginal.toLocaleDateString('es-PE', {
                                                day: '2-digit',
                                                month: '2-digit'
                                            }) + ' ' + fechaInicioOriginal.toLocaleTimeString('es-PE', {
                                                hour: '2-digit',
                                                minute: '2-digit',
                                                hour12: false
                                            });
                                            const finCompleto = fechaFin.toLocaleDateString('es-PE', {
                                                day: '2-digit',
                                                month: '2-digit'
                                            }) + ' ' + fechaFin.toLocaleTimeString('es-PE', {
                                                hour: '2-digit',
                                                minute: '2-digit',
                                                hour12: false
                                            });
                                            horarioTexto = `${inicioCompleto} - ${finCompleto}`;
                                        }

                                        // Extraer solo el motivo del t√≠tulo (sin "Mantenimiento - ")
                                        const motivo = evento.title.replace('Mantenimiento - ', '');

                                        return {
                                            id: evento.id,
                                            title: `${motivo} (${horarioTexto})`, // Incluir horario en el t√≠tulo
                                            start: fechaInicio.toISOString(),
                                            end: evento.end,
                                            backgroundColor: evento.backgroundColor || '#ff6b6b',
                                            borderColor: evento.borderColor || '#ff4757',
                                            textColor: evento.textColor || '#ffffff',
                                            display: evento.display || 'block',
                                            rendering: evento.rendering || 'background',
                                            extendedProps: {
                                                esMantenimiento: true,
                                                estado: evento.estado,
                                                motivo: motivo,
                                                horarioInicio: fechaInicioOriginal.toLocaleString('es-PE'),
                                                horarioFin: fechaFin.toLocaleString('es-PE')
                                            },
                                            classNames: ['evento-mantenimiento']
                                        };
                                    }

                                    // Si no es mantenimiento, procesar como reserva normal
                                    // Filtrar reservas canceladas
                                    if (evento.estado === 'cancelada' || evento.estado === 'CANCELADA') {
                                        return null; // Ser√° filtrado despu√©s
                                    }

                                    const esPropia = evento.esPropia === true;
                                    const estado = evento.estado ? evento.estado.toLowerCase() : null;

                                    let title = esPropia ? 'Mi reserva' : 'Reservado';
                                    if (esPropia && estado) {
                                        switch (estado) {
                                            case 'pendiente': title += ' (Pendiente)'; break;
                                            case 'en_proceso': title += ' (En proceso)'; break;
                                            case 'confirmada': title += ' (Confirmada)'; break;
                                        }
                                    }

                                    return {
                                        id: evento.id,
                                        title: title,
                                        start: evento.start,
                                        end: evento.end,
                                        backgroundColor: evento.backgroundColor,
                                        borderColor: evento.borderColor,
                                        textColor: evento.textColor,
                                        extendedProps: {
                                            esPropia: esPropia,
                                            estado: estado,
                                            esMantenimiento: false
                                        },
                                        classNames: esPropia ? ['reserva-propia'] : ['reserva-ajena']
                                    };
                                }).filter(evento => evento !== null); // Filtrar eventos nulos (cancelados)

                                successCallback(events);
                            })
                            .catch(error => {
                                console.error('Error al cargar reservas:', error);
                                alert('No se pudieron cargar las reservas. Por favor, intente nuevamente.');
                                failureCallback(error);
                            });
                    },

                    // Click en evento existente
                    eventClick: function (info) {
                        // Verificar si es un evento de mantenimiento
                        if (info.event.extendedProps.esMantenimiento === true) {
                            const motivo = info.event.extendedProps.motivo || 'No especificado';
                            const estado = info.event.extendedProps.estado || 'desconocido';
                            const fechaInicio = info.event.extendedProps.horarioInicio;
                            const fechaFin = info.event.extendedProps.horarioFin;

                            let estadoTexto = '';
                            let iconoEstado = '';
                            switch (estado.toLowerCase()) {
                                case 'pendiente':
                                    estadoTexto = 'Programado';
                                    iconoEstado = 'üïê';
                                    break;
                                case 'en_curso':
                                    estadoTexto = 'En progreso';
                                    iconoEstado = 'üîß';
                                    break;
                                case 'finalizado':
                                    estadoTexto = 'Finalizado';
                                    iconoEstado = '‚úÖ';
                                    break;
                                default:
                                    estadoTexto = 'Estado desconocido';
                                    iconoEstado = '‚ùì';
                            }

                            Swal.fire({
                                icon: 'info',
                                title: 'üîß Mantenimiento de Pista',
                                html: `
                                    <div class="text-start">
                                        <p><strong>üèä‚Äç‚ôÇÔ∏è Instalaci√≥n:</strong> Pista</p>
                                        <p><strong>üìã Motivo:</strong> ${motivo}</p>
                                        <p><strong>üìÖ Inicio:</strong> ${fechaInicio}</p>
                                        <p><strong>üèÅ Fin estimado:</strong> ${fechaFin}</p>
                                        <p><strong>${iconoEstado} Estado:</strong> ${estadoTexto}</p>
                                        <hr>
                                        <p class="text-muted small">
                                            <i class="fas fa-info-circle"></i> 
                                            La pista de atletismo no estar√° disponible para reservas durante este per√≠odo.
                                        </p>
                                    </div>
                                `,
                                confirmButtonText: 'Entendido',
                                confirmButtonColor: '#6c757d',
                                width: '500px'
                            });
                            return;
                        }

                        // Solo permitir interacci√≥n con eventos propios
                        if (!info.event.extendedProps.esPropia) {
                            alert("Este horario ya est√° reservado por otro usuario y no se puede modificar.");
                            return;
                        }

                        modal.show();
                        form.reset();
                        selectedEvent = info.event;

                        document.getElementById("create-reservation-form").style.display = "none";
                        document.getElementById("view-reservation-details").style.display = "block";
                        modalTitle.textContent = "Tu reserva";

                        const reservaId = info.event.id;
                        document.getElementById("reserva-id").value = reservaId;

                        cargarDetallesReserva(reservaId);
                    },

                    // Click en fecha vac√≠a
                    dateClick: function (info) {
                        const clickedTime = info.date;

                        if (clickedTime < now) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Fecha inv√°lida',
                                text: 'No puedes reservar en fechas pasadas.',
                                confirmButtonText: 'Aceptar'
                            });
                            return;
                        }

                        const eventsAtTime = calendar.getEvents().filter(event => {
                            return (event.start <= clickedTime && event.end > clickedTime);
                        });

                        if (eventsAtTime.length > 0) {
                            const eventoConflicto = eventsAtTime[0];

                            // Si es un mantenimiento, mostrar mensaje espec√≠fico
                            if (eventoConflicto.extendedProps && eventoConflicto.extendedProps.esMantenimiento) {
                                const motivo = eventoConflicto.extendedProps.motivo || 'mantenimiento programado';
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'üîß Pista en Mantenimiento',
                                    html: `
                                        <div class="text-center">
                                            <p>üèä‚Äç‚ôÇÔ∏è La pista de atletismo no est√° disponible para reservas.</p>
                                            <p><strong>Motivo:</strong> ${motivo}</p>
                                            <hr>
                                            <p class="text-muted small">
                                                <i class="fas fa-clock"></i> 
                                                Vuelve cuando termine el mantenimiento para hacer tu reserva.
                                            </p>
                                        </div>
                                    `,
                                    confirmButtonText: 'Entendido',
                                    confirmButtonColor: '#6c757d'
                                });
                                return;
                            }

                            const esPropiaReserva = eventoConflicto.extendedProps && eventoConflicto.extendedProps.esPropia;
                            if (esPropiaReserva) {
                                alert(`Ya tienes una reserva activa para esta hora. Puedes ver sus detalles haciendo clic en ella.`);
                            } else {
                                alert(`Este horario ya est√° reservado por otro usuario. Por favor selecciona otro horario.`);
                            }
                            return;
                        }

                        abrirFormularioReserva(info);
                    }
                };

                calendar = initializeCalendar(calendarEl, customConfig, horarioApertura, horarioCierre);
                calendar.render();

                configurarNavegacion();
                marcarHorariosPasadosComoNoDisponibles(calendar);
                setInterval(() => marcarHorariosPasadosComoNoDisponibles(calendar), 60000);
            }

            // =============================
            // MANEJO DE CLICKS EN EVENTOS
            // =============================
            function manejarClickEvento(info) {
                if (!info.event.extendedProps.esPropia) {
                    alert("Este horario ya est√° reservado por otro usuario y no se puede modificar.");
                    return;
                }

                modal.show();
                form.reset();
                selectedEvent = info.event;

                document.getElementById("create-reservation-form").style.display = "none";
                document.getElementById("view-reservation-details").style.display = "block";
                modalTitle.textContent = "Tu reserva";

                const reservaId = info.event.id;
                document.getElementById("reserva-id").value = reservaId;

                cargarDetallesReserva(reservaId);
            }

            // =============================
            // CARGAR DETALLES DE RESERVA
            // =============================
            function cargarDetallesReserva(reservaId) {
                fetch(`/usuarios/api/reservas/${reservaId}`)
                    .then(response => response.json())
                    .then(data => {
                        mostrarDetallesBasicos(data);
                        cargarOcupacionHorario(reservaId);
                        configurarBotonesPorEstado(data, reservaId);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('No se pudo cargar los detalles de la reserva');
                    });
            }

            // =============================
            // MOSTRAR DETALLES B√ÅSICOS
            // =============================
            function mostrarDetallesBasicos(data) {
                const startDate = new Date(data.inicioReserva);
                const endDate = new Date(data.finReserva);

                const formatoCompleto = {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                };

                document.getElementById("detail-start").textContent = startDate.toLocaleString('es-PE', formatoCompleto);
                document.getElementById("detail-end").textContent = endDate.toLocaleString('es-PE', formatoCompleto);

                // Carril
                const laneElement = document.getElementById("detail-lane");
                laneElement.textContent = data.numeroCarrilPista ? `Carril ${data.numeroCarrilPista}` : "No especificado";

                // Participantes
                const participantsElement = document.getElementById("detail-participants");
                const numParticipantes = data.numeroParticipantes || 1;
                participantsElement.textContent = `${numParticipantes} ${numParticipantes === 1 ? 'participante' : 'participantes'}`;

                // Estado
                const estadoMap = {
                    'confirmada': { texto: "Confirmada", clase: "text-success" },
                    'pendiente': { texto: "Pendiente de pago", clase: "text-warning" },
                    'en_proceso': { texto: "En proceso", clase: "text-primary" },
                    'cancelada': { texto: "Cancelada", clase: "text-danger" },
                    'completada': { texto: "Completada", clase: "text-info" }
                };

                const estadoInfo = estadoMap[data.estado.toLowerCase()] || { texto: "Desconocido", clase: "" };
                const detailStatus = document.getElementById("detail-status");
                detailStatus.textContent = estadoInfo.texto;
                detailStatus.className = estadoInfo.clase;
            }

            // =============================
            // CARGAR OCUPACI√ìN DEL HORARIO
            // =============================
            function cargarOcupacionHorario(reservaId) {
                fetch(`/api/reserva/${reservaId}/ocupacion`)
                    .then(response => response.json())
                    .then(ocupacionData => {
                        const ocupacionDiv = document.getElementById("detail-ocupacion");

                        if (ocupacionData.error) {
                            ocupacionDiv.innerHTML = `
                        <h6>Ocupaci√≥n del horario</h6>
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>No se pudo obtener la informaci√≥n de ocupaci√≥n.</strong>
                            <small>Intenta nuevamente m√°s tarde.</small>
                        </div>
                    `;
                            return;
                        }

                        if (ocupacionData.tipoOcupacion === "carril") {
                            mostrarOcupacionCarril(ocupacionData, ocupacionDiv);
                        }
                    })
                    .catch(error => {
                        console.error('Error al obtener ocupaci√≥n:', error);
                        const ocupacionDiv = document.getElementById("detail-ocupacion");
                        ocupacionDiv.innerHTML = `
                    <h6>Ocupaci√≥n del horario</h6>
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>No se pudo obtener la informaci√≥n de ocupaci√≥n.</strong>
                        <small>Intenta nuevamente m√°s tarde.</small>
                    </div>
                `;
                    });
            }

            // =============================
            // MOSTRAR OCUPACI√ìN DEL CARRIL
            // =============================
            function mostrarOcupacionCarril(ocupacionData, container) {
                const aforoTotal = ocupacionData.capacidadMaxima;
                const ocupacionActual = ocupacionData.participantesTotales;
                const porcentajeOcupacion = ocupacionData.porcentajeOcupacion;
                const numeroCarril = ocupacionData.numeroCarril;

                let colorBarra = "bg-success";
                let alertClass = "alert-success";
                let mensaje = "Ocupaci√≥n baja. ¬°Buena elecci√≥n para nadar con tranquilidad!";

                if (porcentajeOcupacion >= 100) {
                    colorBarra = "bg-danger";
                    alertClass = "alert-danger";
                    mensaje = "Carril completo. El carril estar√° bastante concurrido.";
                } else if (porcentajeOcupacion >= 75) {
                    colorBarra = "bg-warning";
                    alertClass = "alert-warning";
                    mensaje = "Ocupaci√≥n alta. El carril tendr√° una afluencia considerable.";
                } else if (porcentajeOcupacion >= 50) {
                    colorBarra = "bg-info";
                    alertClass = "alert-info";
                    mensaje = "Ocupaci√≥n media. El carril tendr√° una afluencia moderada.";
                }

                container.innerHTML = `
            <h6>Ocupaci√≥n del horario</h6>
            <div class="alert ${alertClass} mb-0">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Carril ${numeroCarril}: ${ocupacionActual} de ${aforoTotal} personas</strong>
                    <span class="badge bg-secondary">${Math.round(porcentajeOcupacion)}% ocupado</span>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar ${colorBarra}" role="progressbar" 
                        style="width: ${porcentajeOcupacion}%" 
                        aria-valuenow="${ocupacionActual}" aria-valuemin="0" aria-valuemax="${aforoTotal}">
                    </div>
                </div>
                <small class="mt-2 d-block">${mensaje}</small>
                ${ocupacionData.espaciosDisponibles > 0 ?
                        `<small class="text-muted d-block">Espacios libres: ${ocupacionData.espaciosDisponibles}</small>` :
                        '<small class="text-danger d-block">Sin espacios disponibles</small>'
                    }
            </div>
        `;
            }

            // =============================
            // CONFIGURAR BOTONES POR ESTADO
            // =============================
            function configurarBotonesPorEstado(data, reservaId) {
                const btnCancelar = document.getElementById("btn-cancel-reservation");
                const btnVerReservas = document.querySelector("#view-reservation-details a.btn-primary");

                // Limpiar botones existentes
                const btnConfirmarExistente = document.getElementById("btn-confirmar-reserva");
                if (btnConfirmarExistente) {
                    btnConfirmarExistente.remove();
                }

                // Configurar bot√≥n cancelar
                configurarBotonCancelar(btnCancelar, data, reservaId);

                // Configurar botones seg√∫n estado
                if (data.estado.toLowerCase() === 'pendiente') {
                    agregarBotonConfirmar(reservaId, btnCancelar, btnVerReservas);
                } else {
                    if (btnVerReservas) {
                        btnVerReservas.style.display = 'inline-block';
                    }
                }

                // Deshabilitar cancelar si est√° cancelada o completada
                if (['cancelada', 'completada'].includes(data.estado.toLowerCase())) {
                    btnCancelar.classList.add('disabled');
                    btnCancelar.setAttribute('aria-disabled', 'true');
                } else {
                    btnCancelar.classList.remove('disabled');
                    btnCancelar.removeAttribute('aria-disabled');
                }
            }

            // =============================
            // CONFIGURAR BOT√ìN CANCELAR
            // =============================
            function configurarBotonCancelar(btnCancelar, data, reservaId) {
                btnCancelar.onclick = function (e) {
                    e.preventDefault();
                    mostrarConfirmacionCancelacion(data, reservaId);
                    return false;
                };
            }

            // =============================
            // MOSTRAR CONFIRMACI√ìN DE CANCELACI√ìN
            // =============================
            function mostrarConfirmacionCancelacion(data, reservaId) {
                const estadoReserva = data.estado.toLowerCase();
                let tituloConfirmacion = '¬øCancelar reserva?';
                let textoConfirmacion = "Esta acci√≥n no se puede deshacer";
                let iconoConfirmacion = 'warning';

                if (estadoReserva === 'pendiente') {
                    tituloConfirmacion = '¬øCancelar reserva pendiente?';
                    textoConfirmacion = `
                <div class="text-start">
                    <p class="mb-3">La reserva pendiente ser√° cancelada inmediatamente.</p>
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Sin penalizaciones:</strong> Al estar pendiente de pago, no se aplicar√°n cargos adicionales.
                    </div>
                </div>
            `;
                    iconoConfirmacion = 'question';
                } else if (estadoReserva === 'confirmada') {
                    tituloConfirmacion = '¬øCancelar reserva confirmada?';
                    textoConfirmacion = `
                <div class="text-start">
                    <p class="mb-3">Se verificar√° si cumples con el plazo de 48 horas para generar reembolso.</p>
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-clock me-2"></i>
                        <strong>Pol√≠tica de cancelaci√≥n:</strong> Las reservas confirmadas solo pueden cancelarse con al menos 48 horas de anticipaci√≥n para generar reembolso autom√°tico.
                    </div>
                </div>
            `;
                    iconoConfirmacion = 'warning';
                }

                Swal.fire({
                    title: tituloConfirmacion,
                    html: textoConfirmacion,
                    icon: iconoConfirmacion,
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'S√≠, cancelar reserva',
                    cancelButtonText: 'No cancelar',
                    width: '500px',
                    customClass: {
                        htmlContainer: 'text-start'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        procesarCancelacion(reservaId);
                    }
                });
            }

            // =============================
            // PROCESAR CANCELACI√ìN
            // =============================
            function procesarCancelacion(reservaId) {
                Swal.fire({
                    title: 'Procesando cancelaci√≥n...',
                    text: 'Por favor espera mientras procesamos tu solicitud',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                fetch(`/api/cancelar-reserva-pendiente/${reservaId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            mostrarResultadoCancelacion(data);
                        } else {
                            mostrarErrorCancelacion(data);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        mostrarErrorConexion();
                    });
            }

            // =============================
            // MOSTRAR RESULTADO DE CANCELACI√ìN
            // =============================
            function mostrarResultadoCancelacion(data) {
                let mensajeExito = data.mensaje;
                let iconoExito = 'success';

                if (data.tipo === 'cancelacion_directa') {
                    mensajeExito = `
                <div class="text-start">
                    <h5 class="text-success mb-3">Reserva cancelada exitosamente</h5>
                    <p><strong>Tipo:</strong> Reserva pendiente</p>
                    <p class="text-muted mb-0">No se aplicaron penalizaciones. Puedes realizar una nueva reserva cuando gustes.</p>
                </div>
            `;
                } else if (data.tipo === 'cancelacion_con_reembolso') {
                    mensajeExito = `
                <div class="text-start">
                    <h5 class="text-success mb-3">Reserva cancelada exitosamente</h5>
                    <p><strong>Tipo:</strong> Reserva confirmada</p>
                    <div class="alert alert-success mt-3 mb-3">
                        <h6><strong><i class="fas fa-money-bill-wave text-success"></i> Reembolso generado autom√°ticamente:</strong></h6>
                        <p class="mb-1"><strong>Monto:</strong> S/ ${data.montoReembolso}</p>
                        <p class="mb-0"><strong>ID de reembolso:</strong> #${data.reembolsoId}</p>
                    </div>
                    <p class="text-muted mb-0">El reembolso ser√° procesado en los pr√≥ximos d√≠as laborables y recibir√°s una notificaci√≥n por email.</p>
                </div>
            `;
                } else if (data.tipo === 'cancelacion_sin_reembolso_automatico') {
                    iconoExito = 'warning';
                    mensajeExito = `
                <div class="text-start">
                    <h5 class="text-warning mb-3">Reserva cancelada</h5>
                    <p>${data.mensaje}</p>
                    <div class="alert alert-warning mt-3 mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Reembolso manual:</strong> Contacta con nuestro equipo de soporte si necesitas asistencia con el reembolso.
                    </div>
                    <p class="text-muted mb-0">Tel√©fono: (01) 567-8900 | Email: soporte@munisanmiguel.gob.pe</p>
                </div>
            `;
                } else if (data.tipo === 'cancelacion_sin_pago') {
                    iconoExito = 'info';
                    mensajeExito = `
                <div class="text-start">
                    <h5 class="text-info mb-3">‚ÑπReserva cancelada</h5>
                    <p>${data.mensaje}</p>
                    <div class="alert alert-info mt-3 mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Sin pago asociado:</strong> No se encontr√≥ un pago completado para esta reserva.
                    </div>
                    <p class="text-muted mb-0">Si realizaste un pago, por favor contacta con soporte: <i class="fas fa-phone text-info"></i> (01) 567-8900</p>
                </div>
            `;
                }

                Swal.fire({
                    icon: iconoExito,
                    title: 'Cancelaci√≥n procesada',
                    html: mensajeExito,
                    confirmButtonText: 'Aceptar',
                    width: '600px',
                    customClass: {
                        htmlContainer: 'text-start'
                    }
                }).then(() => {
                    modal.hide();
                    calendar.refetchEvents();
                });
            }

            // =============================
            // MOSTRAR ERROR DE CANCELACI√ìN
            // =============================
            function mostrarErrorCancelacion(data) {
                let iconoError = 'error';
                let tituloError = 'Error al cancelar';
                let textoError = data.error || 'No se pudo cancelar la reserva';

                const erroresMap = {
                    'tiempo_insuficiente': {
                        icono: 'warning',
                        titulo: 'Cancelaci√≥n no permitida',
                        texto: `
                    <div class="text-start">
                        <i class="fas fa-info-circle me-2"></i><strong class="mb-3">No se puede cancelar la reserva</strong>
                        <div class="alert alert-warning mt-3 mb-3">
                            <p class="mb-1"><strong>Tiempo insuficiente:</strong> Faltan menos de 48 horas para el inicio.</p>
                            <p class="mb-1"><strong>Horas restantes:</strong> ${data.horasRestantes || 'N/A'}</p>
                            <p class="mb-0"><strong>Pol√≠tica:</strong> Se requieren al menos 48 horas de anticipaci√≥n para generar reembolso.</p>
                        </div>
                    </div>
                `
                    },
                    'ya_cancelada': {
                        icono: 'info',
                        titulo: 'Reserva ya cancelada',
                        texto: `
                    <div class="text-start">
                        <i class="fas fa-info-circle me-2"></i><h5 class="text-info mb-3">Estado actual</h5>
                        <p>Esta reserva ya fue cancelada anteriormente.</p>
                        <p class="text-muted mb-0">No es necesario realizar ninguna acci√≥n adicional.</p>
                    </div>
                `
                    },
                    'completada': {
                        icono: 'info',
                        titulo: 'Cancelaci√≥n no permitida',
                        texto: `
                    <div class="text-start">
                        <h5 class="text-info mb-3"><i class="fas fa-info-circle"></i> Reserva completada</h5>
                        <p>No se puede cancelar una reserva que ya ha sido completada.</p>
                        <p class="text-muted mb-0">La reserva fue utilizada exitosamente.</p>
                    </div>
                `
                    },
                    'en_proceso': {
                        icono: 'info',
                        titulo: 'Cancelaci√≥n no permitida',
                        texto: `
                    <div class="text-start">
                        <h5 class="text-info mb-3"><i class="fas fa-info-circle"></i> Reserva en proceso</h5>
                        <p>No se puede cancelar una reserva que est√° en proceso.</p>
                        <p class="text-muted mb-0">La reserva est√° siendo utilizada actualmente.</p>
                    </div>
                `
                    }
                };

                if (erroresMap[data.tipo]) {
                    iconoError = erroresMap[data.tipo].icono;
                    tituloError = erroresMap[data.tipo].titulo;
                    textoError = erroresMap[data.tipo].texto;
                }

                Swal.fire({
                    icon: iconoError,
                    title: tituloError,
                    html: textoError,
                    confirmButtonText: 'Entendido',
                    width: '600px',
                    customClass: {
                        htmlContainer: 'text-start'
                    }
                });
            }

            // =============================
            // MOSTRAR ERROR DE CONEXI√ìN
            // =============================
            function mostrarErrorConexion() {
                Swal.fire({
                    icon: 'error',
                    title: 'Error de conexi√≥n',
                    html: `
                <div class="text-start">
                    <h5 class="text-danger mb-3">Error de conexi√≥n</h5>
                    <p>No se pudo conectar con el servidor. Verifica tu conexi√≥n a internet e intenta nuevamente.</p>
                    <p class="text-muted mb-0">Si el problema persiste, contacta con soporte t√©cnico.</p>
                </div>
            `,
                    confirmButtonText: 'Aceptar',
                    width: '500px'
                });
            }

            // =============================
            // AGREGAR BOT√ìN CONFIRMAR
            // =============================
            function agregarBotonConfirmar(reservaId, btnCancelar, btnVerReservas) {
                const btnConfirmar = document.createElement("a");
                btnConfirmar.id = "btn-confirmar-reserva";
                btnConfirmar.href = `/usuarios/confirmarReserva/${reservaId}`;
                btnConfirmar.className = "btn btn-success ms-2";
                btnConfirmar.textContent = "Confirmar reserva";

                btnCancelar.parentNode.insertBefore(btnConfirmar, btnVerReservas);

                if (btnVerReservas) {
                    btnVerReservas.style.display = 'none';
                }
            }

            // =============================
            // MANEJO DE CLICKS EN FECHAS
            // =============================
            function manejarClickFecha(info) {
                const clickedTime = info.date;

                if (clickedTime < now) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Fecha inv√°lida',
                        text: 'No puedes reservar en fechas pasadas.',
                        confirmButtonText: 'Aceptar'
                    });
                    return;
                }

                const eventsAtTime = calendar.getEvents().filter(event => {
                    return (event.start <= clickedTime && event.end > clickedTime);
                });

                if (eventsAtTime.length > 0) {
                    const eventoConflicto = eventsAtTime[0];

                    // Si es un mantenimiento, mostrar mensaje espec√≠fico
                    if (eventoConflicto.extendedProps && eventoConflicto.extendedProps.esMantenimiento) {
                        const motivo = eventoConflicto.extendedProps.motivo || 'mantenimiento programado';
                        Swal.fire({
                            icon: 'warning',
                            title: 'üîß Pista en Mantenimiento',
                            html: `
                                <div class="text-center">
                                    <p>üèä‚Äç‚ôÇÔ∏è La pista no est√° disponible para reservas.</p>
                                    <p><strong>Motivo:</strong> ${motivo}</p>
                                    <hr>
                                    <p class="text-muted small">
                                        <i class="fas fa-clock"></i> 
                                        Vuelve cuando termine el mantenimiento para hacer tu reserva.
                                    </p>
                                </div>
                            `,
                            confirmButtonText: 'Entendido',
                            confirmButtonColor: '#6c757d'
                        });
                        return;
                    }

                    const esPropiaReserva = eventoConflicto.extendedProps && eventoConflicto.extendedProps.esPropia;
                    if (esPropiaReserva) {
                        alert(`Ya tienes una reserva activa para esta hora. Puedes ver sus detalles haciendo clic en ella.`);
                    } else {
                        alert(`Este horario ya est√° reservado por otro usuario. Por favor selecciona otro horario.`);
                    }
                    return;
                }

                abrirFormularioReserva(info);
            }

            // =============================
            // ABRIR FORMULARIO DE RESERVA
            // =============================
            function abrirFormularioReserva(info) {
                form.reset();

                document.getElementById("create-reservation-form").style.display = "block";
                document.getElementById("view-reservation-details").style.display = "none";

                const start = new Date(info.date);
                clickInfo = info;

                document.getElementById("event-start").dataset.raw = toLocalISOString(start);

                const formattedDate = start.toLocaleDateString('es-PE');
                const formattedHour = start.toLocaleTimeString('es-PE', {
                    hour: '2-digit', minute: '2-digit', hour12: false
                });
                document.getElementById("event-start").value = `${formattedDate} ${formattedHour}`;

                configurarOpcionesHoraFin(start);
                resetearSelectores();

                document.getElementById("event-end").addEventListener("change", cargarDisponibilidadCarriles);

                modal.show();
                modalTitle.textContent = "Crear Reserva";
                selectedEvent = null;
            }

            // =============================
            // CONFIGURAR OPCIONES HORA FIN
            // =============================
            function configurarOpcionesHoraFin(start) {
                const eventosDelDia = calendar.getEvents()
                    .filter(e => e.start > start && e.start.toDateString() === start.toDateString())
                    .sort((a, b) => a.start - b.start);

                const limiteMax = new Date(start);
                limiteMax.setHours(start.getHours() + 1);

                if (eventosDelDia.length > 0 && eventosDelDia[0].start < limiteMax) {
                    limiteMax.setTime(eventosDelDia[0].start.getTime());
                }

                const endSelect = document.getElementById("event-end");
                endSelect.innerHTML = '<option value="" disabled selected>Seleccione hora de fin</option>';

                const current = new Date(start);
                current.setMinutes(0);
                current.setSeconds(0);
                current.setMilliseconds(0);

                while (current < limiteMax) {
                    current.setMinutes(current.getMinutes() + 60);
                    if (current > limiteMax) break;
                    const option = document.createElement("option");
                    option.value = toLocalISOString(current);
                    option.textContent = current.toLocaleTimeString('es-PE', {
                        hour: '2-digit', minute: '2-digit', hour12: false
                    });
                    endSelect.appendChild(option);
                }
            }

            // =============================
            // RESETEAR SELECTORES
            // =============================
            function resetearSelectores() {
                const laneSelect = document.getElementById("lane-select");
                const participantsSelect = document.getElementById("participants-select");

                laneSelect.innerHTML = '<option value="" disabled selected>Primero seleccione la hora de fin</option>';
                laneSelect.disabled = true;

                participantsSelect.innerHTML = '<option value="" disabled selected>Primero seleccione un carril</option>';
                participantsSelect.disabled = true;

                document.getElementById("price-display").value = "";
            }

            // =============================
            // CARGAR DISPONIBILIDAD DE CARRILES
            // =============================
            function cargarDisponibilidadCarriles() {
                const start = document.getElementById("event-start").dataset.raw;
                const end = document.getElementById("event-end").value;
                const laneSelect = document.getElementById("lane-select");
                const laneInfo = document.getElementById("lane-info");
                const participantsSelect = document.getElementById("participants-select");

                if (!start || !end) return;

                laneSelect.disabled = true;
                laneSelect.innerHTML = '<option value="" disabled selected>Cargando carriles...</option>';
                laneInfo.textContent = "Consultando disponibilidad de carriles...";

                participantsSelect.disabled = true;
                participantsSelect.innerHTML = '<option value="" disabled selected>Primero seleccione un carril</option>';

                fetch(`/api/espacios/${espacioId}/disponibilidad-carriles-atletismo?inicio=${encodeURIComponent(start)}&fin=${encodeURIComponent(end)}`)
                    .then(response => response.json())
                    .then(data => {
                        procesarDisponibilidadCarriles(data, laneSelect, laneInfo);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        laneInfo.textContent = "Error al obtener disponibilidad de carriles";
                        laneSelect.innerHTML = '<option value="" disabled selected>Error al cargar</option>';
                        laneSelect.disabled = true;
                    });
            }

            // =============================
            // PROCESAR DISPONIBILIDAD DE CARRILES
            // =============================
            function procesarDisponibilidadCarriles(data, laneSelect, laneInfo) {
                laneSelect.innerHTML = '<option value="" disabled selected>Seleccione un carril</option>';

                if (data.error) {
                    laneInfo.textContent = "Error: " + data.error;
                    return;
                }

                const carrilInfo = data.carrilInfo;
                const maxPersonasPorCarril = data.maxPersonasPorCarril;

                for (let i = 1; i <= data.totalCarriles; i++) {
                    const info = carrilInfo[i];
                    const option = document.createElement("option");
                    option.value = i;

                    const espaciosDisp = info.espaciosDisponibles;
                    option.textContent = `Carril ${i} - ${espaciosDisp} espacios disponibles`;

                    if (espaciosDisp < 1) {
                        option.disabled = true;
                        option.textContent += " (LLENO)";
                    }

                    laneSelect.appendChild(option);
                }

                laneSelect.disabled = false;
                laneInfo.textContent = `Seleccione un carril con espacios disponibles (m√°ximo ${maxPersonasPorCarril} personas por carril)`;

                document.getElementById("price-display").dataset.precioPorHora = data.precioPorHora;
                document.getElementById("price-display").dataset.maxPersonasPorCarril = maxPersonasPorCarril;

                const laneSelectElement = document.getElementById("lane-select");
                laneSelectElement.removeEventListener("change", handleLaneChange);
                laneSelectElement.addEventListener("change", handleLaneChange);
            }

            // =============================
            // MANEJO DE CAMBIO DE CARRIL
            // =============================
            function handleLaneChange() {
                actualizarOpcionesParticipantes();
            }

            // =============================
            // ACTUALIZAR OPCIONES DE PARTICIPANTES
            // =============================
            function actualizarOpcionesParticipantes() {
                const start = document.getElementById("event-start").dataset.raw;
                const end = document.getElementById("event-end").value;
                const lane = document.getElementById("lane-select").value;
                const participantsSelect = document.getElementById("participants-select");
                const participantsInfo = document.getElementById("participants-info");

                if (!start || !end || !lane) {
                    participantsSelect.disabled = true;
                    participantsSelect.innerHTML = '<option value="" disabled selected>Primero seleccione un carril</option>';
                    return;
                }

                fetch(`/api/verificar-disponibilidad-atletismo?espacioId=${espacioId}&inicio=${encodeURIComponent(start)}&fin=${encodeURIComponent(end)}&carril=${lane}&participantes=1`)
                    .then(response => response.json())
                    .then(data => {
                        participantsSelect.innerHTML = '';

                        if (data.disponible && data.espaciosDisponibles > 0) {
                            for (let i = 1; i <= data.espaciosDisponibles; i++) {
                                const option = document.createElement("option");
                                option.value = i;
                                option.textContent = `${i} participante${i > 1 ? 's' : ''}`;
                                participantsSelect.appendChild(option);
                            }

                            participantsSelect.value = "1";
                            participantsSelect.disabled = false;
                            participantsInfo.textContent = `Espacios disponibles en el carril ${lane}: ${data.espaciosDisponibles}`;
                            calcularPrecio();
                        } else {
                            participantsSelect.innerHTML = '<option value="" disabled selected>Carril no disponible</option>';
                            participantsSelect.disabled = true;
                            participantsInfo.textContent = data.mensaje || "Este carril no tiene espacios disponibles";
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        participantsSelect.innerHTML = '<option value="" disabled selected>Error al consultar</option>';
                        participantsSelect.disabled = true;
                        participantsInfo.textContent = "Error al consultar disponibilidad del carril";
                    });
            }

            // =============================
            // CALCULAR PRECIO
            // =============================
            function calcularPrecio() {
                const start = document.getElementById("event-start").dataset.raw;
                const end = document.getElementById("event-end").value;
                const lane = document.getElementById("lane-select").value;
                const participants = document.getElementById("participants-select").value;
                const priceDisplay = document.getElementById("price-display");

                if (!start || !end || !lane || !participants || !priceDisplay.dataset.precioPorHora) {
                    priceDisplay.value = "";
                    return;
                }

                const startDate = new Date(start);
                const endDate = new Date(end);
                let hours = (endDate - startDate) / (1000 * 60 * 60);
                if (hours < 1) hours = 1;

                const precioPorHora = parseFloat(priceDisplay.dataset.precioPorHora);
                const total = precioPorHora * hours * parseInt(participants);

                priceDisplay.value = total.toFixed(2);

                const participantsInfo = document.getElementById("participants-info");
                participantsInfo.textContent = `El precio total es S/. ${total.toFixed(2)} (${precioPorHora} √ó ${hours} horas √ó ${participants} participante${participants !== '1' ? 's' : ''})`;
            }

            // =============================
            // CONFIGURAR NAVEGACI√ìN
            // =============================
            function configurarNavegacion() {
                function controlNavigation() {
                    const now = new Date();
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay() + 1);
                    startOfWeek.setHours(0, 0, 0, 0);

                    const currentView = calendar.view;
                    const viewStart = new Date(currentView.activeStart);

                    const prevButton = document.querySelector('.fc-prev-button');
                    if (prevButton) {
                        if (viewStart < startOfWeek) {
                            prevButton.disabled = true;
                            prevButton.style.opacity = '0.5';
                            prevButton.style.cursor = 'not-allowed';
                            prevButton.title = 'No se pueden ver semanas pasadas';
                        } else {
                            prevButton.disabled = false;
                            prevButton.style.opacity = '1';
                            prevButton.style.cursor = 'pointer';
                            prevButton.title = 'Semana anterior';
                        }
                    }
                }

                setTimeout(controlNavigation, 100);
                calendar.on('datesSet', controlNavigation);

                document.addEventListener('click', function (e) {
                    if (e.target.classList.contains('fc-prev-button') && e.target.disabled) {
                        e.preventDefault();
                        e.stopPropagation();
                        return false;
                    }
                });
            }

            // =============================
            // CONFIGURAR ENV√çO DE FORMULARIO
            // =============================
            function configurarEnvioFormulario() {
                document.getElementById("form-event").addEventListener("submit", function (e) {
                    e.preventDefault();

                    const rawStart = document.getElementById("event-start").dataset.raw;
                    const rawEnd = document.getElementById("event-end").value;
                    const carril = document.getElementById("lane-select").value;
                    const participantes = document.getElementById("participants-select").value;

                    if (!rawStart || !rawEnd || !carril || !participantes) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Datos incompletos',
                            text: 'Por favor seleccione hora de inicio, fin, carril y n√∫mero de participantes.',
                            confirmButtonText: 'Entendido'
                        });
                        return;
                    }

                    const btnSave = document.getElementById("btn-save-event");
                    const originalText = btnSave.textContent;
                    btnSave.disabled = true;
                    btnSave.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Verificando...';

                    const verificarUrl = `/api/verificar-disponibilidad-atletismo?espacioId=${espacioId}&inicio=${encodeURIComponent(rawStart)}&fin=${encodeURIComponent(rawEnd)}&carril=${carril}&participantes=${participantes}`;

                    fetch(verificarUrl)
                        .then(response => response.json())
                        .then(data => {
                            if (data.disponible) {
                                // Proceder con la reserva
                                document.getElementById("input-espacio-id").value = espacioId;
                                document.getElementById("input-fecha-inicio").value = rawStart;
                                document.getElementById("input-fecha-fin").value = rawEnd;
                                document.getElementById("input-carril-atletismo").value = carril;
                                document.getElementById("input-participantes-atletismo").value = participantes;

                                console.log('Valores asignados:', {
                                    espacioId: espacioId,
                                    fechaInicio: rawStart,
                                    fechaFin: rawEnd,
                                    carril: carril,
                                    participantes: participantes
                                });

                                form.submit();
                            } else {
                                // Mostrar mensaje de error espec√≠fico seg√∫n el tipo
                                let icono = 'error';
                                let titulo = 'Horario no disponible';

                                if (data.razon === 'mantenimiento') {
                                    icono = 'warning';
                                    titulo = 'üîß Mantenimiento Programado';

                                    // Mostrar informaci√≥n detallada del mantenimiento
                                    let detalleMantenimiento = '';
                                    if (data.mantenimientos && data.mantenimientos.length > 0) {
                                        detalleMantenimiento = '<br><br><strong>Detalles:</strong><ul>';
                                        data.mantenimientos.forEach(m => {
                                            const inicio = new Date(m.fechaInicio).toLocaleString('es-PE');
                                            const fin = new Date(m.fechaFin).toLocaleString('es-PE');
                                            detalleMantenimiento += `<li><strong>${m.motivo}</strong><br>üìÖ ${inicio} - ${fin}<br>üîß Estado: ${m.estado}</li>`;
                                        });
                                        detalleMantenimiento += '</ul>';
                                    }

                                    Swal.fire({
                                        icon: icono,
                                        title: titulo,
                                        html: data.mensaje + detalleMantenimiento,
                                        confirmButtonText: 'Entendido',
                                        confirmButtonColor: '#6c757d'
                                    });
                                } else {
                                    Swal.fire({
                                        icon: icono,
                                        title: titulo,
                                        text: data.mensaje,
                                        confirmButtonText: 'Entendido'
                                    });
                                }

                                // Actualizar calendario para mostrar cambios
                                calendar.refetchEvents();
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error de conexi√≥n',
                                text: 'No se pudo verificar la disponibilidad. Intente nuevamente.',
                                confirmButtonText: 'Aceptar'
                            });
                        })
                        .finally(() => {
                            btnSave.disabled = false;
                            btnSave.textContent = originalText;
                        });
                });
            }

            // =============================
            // CONFIGURAR TOOLTIPS
            // =============================
            function configurarTooltips() {
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl, {
                        trigger: 'click',
                        placement: 'left',
                        html: true
                    });
                });

                document.addEventListener('click', function (e) {
                    if (!e.target.closest('[data-bs-toggle="tooltip"]')) {
                        tooltipList.forEach(tooltip => tooltip.hide());
                    }
                });
            }

            // =============================
            // FUNCI√ìN AUXILIAR
            // =============================
            function toLocalISOString(date) {
                const pad = n => n < 10 ? '0' + n : n;
                return date.getFullYear() + '-' +
                    pad(date.getMonth() + 1) + '-' +
                    pad(date.getDate()) + 'T' +
                    pad(date.getHours()) + ':' +
                    pad(date.getMinutes()) + ':' +
                    pad(date.getSeconds());
            }

            // =============================
            // INICIALIZACI√ìN PRINCIPAL
            // =============================
            function inicializar() {
                verificarConflictosIniciales();
                configurarCalendario();
                configurarEnvioFormulario();
                configurarTooltips();

                // Agregar listener para cambios en participantes
                document.getElementById("participants-select").addEventListener("change", calcularPrecio);
            }

            // =============================
            // EJECUTAR INICIALIZACI√ìN
            // =============================
            inicializar();
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{Superadmin/fragments/head.html :: head(title='Realizar reserva')}">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body data-sidebar="dark" class="vertical-collpsed">
    <div id="layout-wrapper">
        <div th:replace="~{Vecino/fragments/topbarVecino :: topbar('Calendario')}"></div>
        <div th:replace="~{Vecino/fragments/sidebarVecino :: sidebar('Calendario')}"></div>

        <div class="main-content">
            <div class="page-content" style="min-height: 100%;">
                <div class="container-fluid">

                    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                        <span th:text="${error}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>

                    <!-- start page title -->
                    <div class="row">
                        <div class="col-12">
                            <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                                <h4 class="mb-sm-0">Reservar espacio deportivo</h4>
                                <div class="page-title-right">
                                    <a th:href="@{/usuarios/cancha}" class="btn ms-2 btn-outline-primary">
                                        <i class="fas fa-arrow-left me-1"></i> Regresar a espacios
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div><!-- end page title -->
                    <div class="row mb-4">
                        <!-- Detalles del espacio deportivo -->
                        <div class="col-xl-3 col-lg-4">
                            <div class="card">
                                <!-- Foto del establecimiento deportivo -->
                                <div class="position-relative">
                                    <img th:src="${espacio.fotoEspacioDeportivoUrl != null ? espacio.fotoEspacioDeportivoUrl : '/assets/images/canchita.jpg'}"
                                        alt="Establecimiento Deportivo" class="card-img-top"
                                        style="height: 160px; object-fit: cover;">
                                </div>
                                <div class="card-header d-flex justify-content-between align-items-center py-2">
                                    <h4 class="card-title mb-0 fw-bold py-1" th:text="${espacio.nombre}">Espacio
                                        Deportivo</h4>
                                    <button class="btn btn-link p-0 text-primary" data-bs-toggle="tooltip"
                                        data-bs-placement="left" data-bs-trigger="click" data-bs-html="true"
                                        th:attr="data-bs-title='<div class=&quot;text-start&quot;><strong>Informaci√≥n de reservas:</strong><br>‚Ä¢ Haz clic en un horario disponible para reservar<br>‚Ä¢ Las reservas deben ser confirmadas<br>‚Ä¢ Cancela con 2 horas de anticipaci√≥n<br>‚Ä¢ M√°ximo 2 horas por reserva</div>'">
                                        <i class="fas fa-info-circle fs-4"></i>
                                    </button>
                                </div>
                                <div class="card-body py-4">
                                    <div class="space-details">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-muted">Capacidad:</span>
                                            <span class="fw-medium">
                                                <i class="fas fa-users text-info me-2"></i>
                                                <span th:text="${espacio.aforoGimnasio != null ? espacio.aforoGimnasio : 
                                                                     (espacio.maxPersonasPorCarril != null ? espacio.maxPersonasPorCarril + ' por carril' : 
                                                                      '22')}">22</span>
                                            </span>
                                        </div>

                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-muted">Precio por hora:</span>
                                            <span class="text-success fw-bold">
                                                <i class="fas fa-dollar-sign me-2"></i>
                                                S/. <span
                                                    th:text="${espacio.precioPorHora != null ? espacio.precioPorHora : '50.00'}">50.00</span>
                                            </span>
                                        </div>

                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-muted">Horario:</span>
                                            <span>
                                                <i class="fas fa-clock text-warning me-2"></i>
                                                <span th:text="${espacio.horarioApertura != null && espacio.horarioCierre != null ? 
                                                                     #temporals.format(espacio.horarioApertura, 'HH:mm') + ' - ' + #temporals.format(espacio.horarioCierre, 'HH:mm') : 
                                                                     '7:00 - 22:00'}">7:00 - 22:00</span>
                                            </span>
                                        </div>

                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="text-muted">Estado:</span>
                                            <span>
                                                <span class="badge bg-success-subtle text-success"
                                                    th:if="${espacio.estadoServicio.name() == 'operativo'}">
                                                    <i class="fas fa-check-circle me-1"></i>Disponible
                                                </span>
                                                <span class="badge bg-warning-subtle text-warning"
                                                    th:if="${espacio.estadoServicio.name() == 'mantenimiento'}">
                                                    <i class="fas fa-tools me-1"></i>Mantenimiento
                                                </span>
                                                <span class="badge bg-danger-subtle text-danger"
                                                    th:if="${espacio.estadoServicio.name() == 'clausurado'}">
                                                    <i class="fas fa-times-circle me-1"></i>Clausurado
                                                </span>
                                            </span>
                                        </div>
                                        <div th:if="${espacio.descripcion}" class="mb-3 pb-3 border-bottom">
                                            <div class="d-flex align-items-start mb-2">
                                                <i class="fas fa-info-circle text-primary me-2 mt-1"></i>
                                                <span class="text-muted fw-medium">Descripci√≥n</span>
                                            </div>
                                            <p th:text="${espacio.descripcion}"
                                                class="text-secondary mb-0 lh-base ps-4">Descripci√≥n del espacio...</p>
                                        </div>

                                        <div th:if="${espacio.geolocalizacion}" class="mb-0">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                                <span class="text-muted fw-medium">Ubicaci√≥n</span>
                                            </div>
                                            <div class="map-container"
                                                style="height: 150px; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb;">
                                                <!-- Alternativa 1: Si las coordenadas est√°n en formato "lat,lng" -->
                                                <iframe th:if="${#strings.contains(espacio.geolocalizacion, ',')}"
                                                    th:src="'https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dO_iY_G7yQT2Kc&q=' + ${espacio.geolocalizacion}"
                                                    width="100%" height="100%" style="border:0;" allowfullscreen=""
                                                    loading="lazy" referrerpolicy="no-referrer-when-downgrade">
                                                </iframe>
                                                <!-- Alternativa 2: Si es una direcci√≥n de texto -->
                                                <iframe th:unless="${#strings.contains(espacio.geolocalizacion, ',')}"
                                                    th:src="'https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dO_iY_G7yQT2Kc&q=' + ${#strings.replace(espacio.geolocalizacion, ' ', '+')}"
                                                    width="100%" height="100%" style="border:0;" allowfullscreen=""
                                                    loading="lazy" referrerpolicy="no-referrer-when-downgrade">
                                                </iframe>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Calendario -->
                        <div class="col-xl-9 col-lg-8">
                            <div class="card mb-0">
                                <div class="card-body calendar-container">
                                    <div id="calendar" style="height: 100%;"
                                        th:attr="data-espacio-id=${espacioId},
              data-horario-apertura=${espacio.horarioApertura != null ? #temporals.format(espacio.horarioApertura, 'HH:mm:ss') : '07:00:00'},
              data-horario-cierre=${espacio.horarioCierre != null ? #temporals.format(espacio.horarioCierre, 'HH:mm:ss') : '22:00:00'}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> <!-- end row-->
                    <div style='clear:both'></div>

                    <!-- Add New Event MODAL -->
                    <div class="modal fade" id="event-modal" data-bs-backdrop="static" data-bs-keyboard="false"
                        tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header py-3 px-4">
                                    <h5 class="modal-title" id="modal-title">Crear Reserva</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body p-4">
                                    <form class="needs-validation" name="event-form" id="form-event" novalidate
                                        th:action="@{/usuarios/crear-reserva-calendario}" method="post">
                                        <input type="hidden" name="title" id="event-title" value="Reservado">
                                        <input type="hidden" name="reservaId" id="reserva-id">
                                        <input type="hidden" name="espacioId" id="input-espacio-id">
                                        <input type="hidden" name="fechaInicio" id="input-fecha-inicio">
                                        <input type="hidden" name="fechaFin" id="input-fecha-fin">
                                        <!-- Agregar junto a los otros inputs ocultos -->
                                        <input type="hidden" name="numeroParticipantes" id="input-numero-participantes">
                                        <div id="create-reservation-form">
                                            <div class="mb-3">
                                                <label class="form-label" for="event-start">Hora de inicio</label>
                                                <input class="form-control" type="text" id="event-start" name="start"
                                                    readonly>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label" for="event-end">Hora de fin (duraci√≥n: 1
                                                    hora)</label>
                                                <input class="form-control" type="text" id="event-end" name="end"
                                                    readonly>
                                                <div class="form-text">Las reservas tienen una duraci√≥n fija de 1 hora.
                                                </div>
                                            </div>

                                            <!-- Agregar despu√©s del campo de hora de fin -->
                                            <div class="mb-3">
                                                <label class="form-label" for="event-participants">N√∫mero de
                                                    participantes</label>
                                                <select class="form-control" id="event-participants"
                                                    name="numeroParticipantes" required>
                                                    <option value="1" selected>1 persona</option>
                                                    <option value="2">2 personas</option>
                                                    <option value="3">3 personas</option>
                                                    <option value="4">4 personas</option>
                                                    <option value="5">5 personas</option>
                                                </select>
                                                <div class="form-text">El precio se calcula seg√∫n el n√∫mero de
                                                    participantes.</div>
                                            </div>

                                            <!-- Agregar campo para mostrar precio total -->
                                            <div class="mb-3">
                                                <label class="form-label">Precio total</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">S/.</span>
                                                    <input type="text" class="form-control" id="event-price" readonly>
                                                    <input type="hidden" name="precioTotal" id="input-precio-total">
                                                </div>
                                            </div>

                                            <!-- Nuevo div para mostrar informaci√≥n de aforo -->
                                            <div class="mb-3">
                                                <label class="form-label">Disponibilidad</label>
                                                <div id="gimnasio-disponibilidad" class="p-3 rounded border">
                                                    <div class="text-center">
                                                        <div class="spinner-border spinner-border-sm text-primary"
                                                            role="status"></div>
                                                        <span class="ms-2">Cargando disponibilidad...</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row mt-2">
                                                <div class="col-6">
                                                </div>
                                                <div class="col-6 text-end">
                                                    <button type="button" class="btn btn-light me-1"
                                                        data-bs-dismiss="modal">Cerrar</button>
                                                    <button type="submit" class="btn btn-success"
                                                        id="btn-save-event">Crear</button>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="view-reservation-details" style="display: none;">
                                            <div class="mb-3">
                                                <h6>Detalles de tu reserva</h6>
                                                <table class="table table-borderless mb-0">
                                                    <tbody>
                                                        <tr>
                                                            <th scope="row">Inicio:</th>
                                                            <td id="detail-start"></td>
                                                        </tr>
                                                        <tr>
                                                            <th scope="row">Fin:</th>
                                                            <td id="detail-end"></td>
                                                        </tr>
                                                        <tr>
                                                            <th scope="row">Estado:</th>
                                                            <td id="detail-status"></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-12 text-end">
                                                    <button type="button" class="btn btn-light"
                                                        data-bs-dismiss="modal">Cerrar</button>
                                                    <a href="#" id="btn-cancel-reservation"
                                                        class="btn btn-danger">Cancelar reserva</a>
                                                    <a href="/usuarios/mis-reservas" class="btn btn-primary">Ver todas
                                                        mis reservas</a>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- end modal-->

                </div>
            </div>

            <div th:replace="~{Superadmin/fragments/footer.html :: footer}"></div>
        </div>
    </div> <!-- Scripts -->
    <div th:replace="~{Superadmin/fragments/foot.html :: foot}"></div>

    <!-- SweetAlert2 para notificaciones de conflictos -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Esperar a que el DOM est√© completamente cargado
        document.addEventListener('DOMContentLoaded', function () {
            // Verificar si hay un conflicto detectado desde el servidor
            const conflictoDetectado = /*[[${conflictoDetectado}]]*/ false;
            const mensajeConflicto = /*[[${mensajeConflicto}]]*/ '';

            if (conflictoDetectado && mensajeConflicto) {
                Swal.fire({
                    icon: 'error',
                    title: 'Conflicto de Reserva',
                    text: mensajeConflicto,
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#d33'
                });
            }

            // Referencias a elementos DOM usando JavaScript puro
            const modalEl = document.getElementById('event-modal');
            const modal = new bootstrap.Modal(modalEl);
            const modalTitle = document.getElementById('modal-title');
            const form = document.getElementById('form-event');
            const calendarEl = document.getElementById('calendar');

            let selectedEvent = null;
            let clickInfo = null;

            const espacioId = calendarEl.dataset.espacioId;
            const horarioApertura = calendarEl.dataset.horarioApertura || '07:00:00';
            const horarioCierre = calendarEl.dataset.horarioCierre || '22:00:00';
            console.log(`Espacio ID: ${espacioId}, Horario Apertura: ${horarioApertura}, Horario Cierre: ${horarioCierre}`);
            const now = new Date();

            // Usar la configuraci√≥n base del archivo calendar-config.js
            const customConfig = {
                // Configuraci√≥n de eventos espec√≠fica para este calendario
                eventClassNames: function (arg) {
                    try {
                        const evento = arg.event;
                        const esPropia = evento.extendedProps && evento.extendedProps.esPropia === true;
                        const estado = evento.extendedProps && evento.extendedProps.estado;

                        // Si no es propia, siempre mostrar como ajena
                        if (!esPropia) return ['reserva-ajena'];

                        // Si es propia, asignar clase seg√∫n estado
                        if (estado === 'confirmada') {
                            return ['reserva-propia-confirmada'];
                        } else if (estado === 'pendiente') {
                            return ['reserva-propia-pendiente'];
                        } else if (estado === 'en_proceso') {
                            return ['reserva-propia-en-proceso'];
                        }

                        // Por defecto
                        return ['reserva-propia-pendiente'];
                    } catch (error) {
                        console.error("Error al asignar clases a evento:", error);
                        return [];
                    }
                },

                events: function (info, successCallback, failureCallback) {
                    fetch('/api/reservas/gimnasio/' + espacioId)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Error al cargar reservas: ' + response.status);
                            }
                            return response.json();
                        })
                        .then(data => {
                            // Procesar todos los eventos (reservas y mantenimientos)
                            const events = data.map(evento => {
                                // Verificar si es un evento de mantenimiento
                                if (evento.esMantenimiento === true) {
                                    // Formatear las fechas para mostrar en el t√≠tulo
                                    const fechaInicioOriginal = new Date(evento.start);
                                    const fechaFin = new Date(evento.end);
                                    const ahora = new Date();

                                    // Determinar la fecha de inicio efectiva
                                    let fechaInicio = fechaInicioOriginal;

                                    // Si el mantenimiento est√° en curso y ya empez√≥, usar la hora actual
                                    if (evento.estado && evento.estado.toLowerCase() === 'en_curso' || fechaInicioOriginal < ahora) {
                                        fechaInicio = ahora;
                                    }

                                    // Formatear solo la hora si es el mismo d√≠a, o fecha completa si es diferente d√≠a
                                    let horarioTexto = '';
                                    if (fechaInicioOriginal.toDateString() === fechaFin.toDateString()) {
                                        // Mismo d√≠a - mostrar solo las horas
                                        const horaInicio = fechaInicioOriginal.toLocaleTimeString('es-PE', {
                                            hour: '2-digit',
                                            minute: '2-digit',
                                            hour12: false
                                        });
                                        const horaFin = fechaFin.toLocaleTimeString('es-PE', {
                                            hour: '2-digit',
                                            minute: '2-digit',
                                            hour12: false
                                        });
                                        horarioTexto = `${horaInicio} - ${horaFin}`;
                                    } else {
                                        // Diferentes d√≠as - mostrar fecha y hora
                                        const inicioCompleto = fechaInicioOriginal.toLocaleDateString('es-PE', {
                                            day: '2-digit',
                                            month: '2-digit'
                                        }) + ' ' + fechaInicioOriginal.toLocaleTimeString('es-PE', {
                                            hour: '2-digit',
                                            minute: '2-digit',
                                            hour12: false
                                        });
                                        const finCompleto = fechaFin.toLocaleDateString('es-PE', {
                                            day: '2-digit',
                                            month: '2-digit'
                                        }) + ' ' + fechaFin.toLocaleTimeString('es-PE', {
                                            hour: '2-digit',
                                            minute: '2-digit',
                                            hour12: false
                                        });
                                        horarioTexto = `${inicioCompleto} - ${finCompleto}`;
                                    }

                                    // Extraer solo el motivo del t√≠tulo (sin "Mantenimiento - ")
                                    const motivo = evento.title.replace('Mantenimiento - ', '');

                                    return {
                                        id: evento.id,
                                        title: `${motivo} (${horarioTexto})`, // Incluir horario en el t√≠tulo
                                        start: fechaInicio.toISOString(),
                                        end: evento.end,
                                        backgroundColor: evento.backgroundColor || '#ff6b6b',
                                        borderColor: evento.borderColor || '#ff4757',
                                        textColor: evento.textColor || '#ffffff',
                                        display: evento.display || 'block',
                                        rendering: evento.rendering || 'background',
                                        extendedProps: {
                                            esMantenimiento: true,
                                            estado: evento.estado,
                                            motivo: motivo,
                                            horarioInicio: fechaInicioOriginal.toLocaleString('es-PE'),
                                            horarioFin: fechaFin.toLocaleString('es-PE')
                                        },
                                        classNames: ['evento-mantenimiento']
                                    };
                                }

                                // Si no es mantenimiento, procesar como reserva normal
                                // Filtrar reservas canceladas
                                if (evento.estado === 'cancelada' || evento.estado === 'CANCELADA') {
                                    return null;
                                }

                                const esPropia = evento.esPropia === true;
                                const estado = evento.estado ? evento.estado.toLowerCase() : null;

                                let title = esPropia ? 'Mi reserva' : 'Reservado';
                                if (esPropia && estado) {
                                    switch (estado) {
                                        case 'pendiente': title += ' (Pendiente)'; break;
                                        case 'en_proceso': title += ' (En proceso)'; break;
                                        case 'confirmada': title += ' (Confirmada)'; break;
                                    }
                                }

                                return {
                                    id: evento.id,
                                    title: title,
                                    start: evento.start,
                                    end: evento.end,
                                    backgroundColor: evento.backgroundColor,
                                    borderColor: evento.borderColor,
                                    textColor: evento.textColor,
                                    extendedProps: {
                                        esPropia: esPropia,
                                        estado: estado,
                                        esMantenimiento: false
                                    }
                                };
                            }).filter(evento => evento !== null);

                            successCallback(events);
                        })
                        .catch(error => {
                            console.error('Error al cargar reservas:', error);
                            alert('No se pudieron cargar las reservas. Por favor, intente nuevamente.');
                            failureCallback(error);
                        });
                },

                eventClick: function (info) {
                    // Verificar si es un evento de mantenimiento
                    if (info.event.extendedProps.esMantenimiento === true) {
                        const motivo = info.event.extendedProps.motivo || 'No especificado';
                        const estado = info.event.extendedProps.estado || 'desconocido';
                        const fechaInicio = info.event.extendedProps.horarioInicio;
                        const fechaFin = info.event.extendedProps.horarioFin;

                        let estadoTexto = '';
                        let iconoEstado = '';
                        switch (estado.toLowerCase()) {
                            case 'pendiente':
                                estadoTexto = 'Programado';
                                iconoEstado = 'üïê';
                                break;
                            case 'en_curso':
                                estadoTexto = 'En progreso';
                                iconoEstado = 'üîß';
                                break;
                            case 'finalizado':
                                estadoTexto = 'Finalizado';
                                iconoEstado = '‚úÖ';
                                break;
                            default:
                                estadoTexto = 'Estado desconocido';
                                iconoEstado = '‚ùì';
                        }

                        Swal.fire({
                            icon: 'info',
                            title: 'üîß Mantenimiento de Gimnasio',
                            html: `
                                <div class="text-start">
                                    <p><strong>Instalaci√≥n:</strong> Gimnasio</p>
                                    <p><strong>Motivo:</strong> ${motivo}</p>
                                    <p><strong>Inicio:</strong> ${fechaInicio}</p>
                                    <p><strong>Fin estimado:</strong> ${fechaFin}</p>
                                    <p><strong>${iconoEstado} Estado:</strong> ${estadoTexto}</p>
                                    <hr>
                                    <p class="text-muted small">
                                        <i class="fas fa-info-circle"></i> 
                                        El gimnasio no estar√° disponible para reservas durante este per√≠odo.
                                    </p>
                                </div>
                            `,
                            confirmButtonText: 'Entendido',
                            confirmButtonColor: '#6c757d',
                            width: '500px'
                        });
                        return;
                    }

                    // Solo permitir interacci√≥n con eventos propios
                    if (!info.event.extendedProps.esPropia) {
                        alert("Este horario ya est√° reservado por otro usuario y no se puede modificar.");
                        return;
                    }

                    // Mostrar modal con detalles de la reserva
                    modal.show();
                    form.reset();
                    selectedEvent = info.event;

                    // Ocultar formulario de creaci√≥n y mostrar vista de detalles
                    document.getElementById("create-reservation-form").style.display = "none";
                    document.getElementById("view-reservation-details").style.display = "block";

                    // Establecer t√≠tulo modal
                    modalTitle.textContent = "Tu reserva";

                    // Obtener ID de la reserva
                    const reservaId = info.event.id;
                    document.getElementById("reserva-id").value = reservaId;

                    // Crear div para mostrar informaci√≥n de ocupaci√≥n si no existe
                    if (!document.getElementById("detail-ocupacion")) {
                        const ocupacionDiv = document.createElement("div");
                        ocupacionDiv.id = "detail-ocupacion";
                        ocupacionDiv.className = "mb-3 mt-3";
                        ocupacionDiv.innerHTML = `
                            <h6>Ocupaci√≥n actual</h6>
                            <div class="p-3 rounded border">
                                <div class="text-center">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    <span class="ms-2">Consultando ocupaci√≥n...</span>
                                </div>
                            </div>
                        `;
                        document.getElementById("view-reservation-details").insertBefore(
                            ocupacionDiv,
                            document.querySelector("#view-reservation-details .row")
                        );
                    }

                    // Obtener datos detallados de la reserva mediante API
                    fetch(`/usuarios/api/reservas/${reservaId}`)
                        .then(response => response.json())
                        .then(data => {
                            // Formatear fechas
                            const startDate = new Date(data.inicioReserva);
                            const endDate = new Date(data.finReserva);

                            document.getElementById("detail-start").textContent = startDate.toLocaleString('es-PE', {
                                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                                hour: '2-digit', minute: '2-digit'
                            });

                            document.getElementById("detail-end").textContent = endDate.toLocaleString('es-PE', {
                                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                                hour: '2-digit', minute: '2-digit'
                            });

                            // Mostrar estado con formato m√°s amigable
                            let estadoTexto = "Desconocido";
                            let estadoClase = "";

                            switch (data.estado.toLowerCase()) {
                                case 'confirmada': estadoTexto = "Confirmada"; estadoClase = "text-success"; break;
                                case 'pendiente': estadoTexto = "Pendiente de pago"; estadoClase = "text-warning"; break;
                                case 'en_proceso': estadoTexto = "En proceso"; estadoClase = "text-primary"; break;
                                case 'cancelada': estadoTexto = "Cancelada"; estadoClase = "text-danger"; break;
                                case 'completada': estadoTexto = "Completada"; estadoClase = "text-info"; break;
                            }

                            const detailStatus = document.getElementById("detail-status");
                            detailStatus.textContent = estadoTexto;
                            detailStatus.className = estadoClase;

                            // Declarar las variables de los botones antes de usarlas
                            let btnVerReservas = document.querySelector("#view-reservation-details a.btn-primary");
                            let btnCancelar = document.getElementById("btn-cancel-reservation");

                            // Configurar cancelaci√≥n mediante AJAX en lugar de href directo
                            btnCancelar.onclick = function (e) {
                                e.preventDefault();

                                // Obtener el estado de la reserva para mostrar mensaje apropiado
                                const estadoReserva = data.estado.toLowerCase();
                                let tituloConfirmacion = '¬øCancelar reserva?';
                                let textoConfirmacion = "Esta acci√≥n no se puede deshacer";

                                // Personalizar mensaje seg√∫n el estado
                                if (estadoReserva === 'pendiente') {
                                    tituloConfirmacion = '¬øCancelar reserva pendiente?';
                                    textoConfirmacion = "La reserva pendiente ser√° cancelada inmediatamente sin penalizaci√≥n.";
                                } else if (estadoReserva === 'confirmada') {
                                    tituloConfirmacion = '¬øCancelar reserva confirmada?';
                                    textoConfirmacion = "Solo se puede cancelar si faltan m√°s de 48 horas para el inicio de la reserva.";
                                }

                                // Mostrar modal con input para la raz√≥n de cancelaci√≥n
                                Swal.fire({
                                    title: tituloConfirmacion,
                                    html: `
            <div class="text-start mb-3">
                <p class="mb-3">${textoConfirmacion}</p>
            </div>
        `,
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonColor: '#d33',
                                    cancelButtonColor: '#3085d6',
                                    confirmButtonText: 'S√≠, cancelar reserva',
                                    cancelButtonText: 'No cancelar',
                                    width: '600px',
                                    focusConfirm: false,
                                    preConfirm: () => {
                                        const razonInput = document.getElementById('razon-cancelacion');
                                        return {
                                            razon: razonInput.value.trim() || 'Cancelaci√≥n solicitada por el usuario'
                                        };
                                    }
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        const razonCancelacion = result.value.razon;

                                        // Mostrar indicador de carga
                                        Swal.fire({
                                            title: 'Procesando cancelaci√≥n...',
                                            text: 'Por favor espera mientras procesamos tu solicitud',
                                            allowOutsideClick: false,
                                            didOpen: () => {
                                                Swal.showLoading();
                                            }
                                        });

                                        // Realizar la cancelaci√≥n mediante AJAX con la raz√≥n personalizada
                                        const cancelarUrl = `/api/cancelar-reserva-pendiente/${reservaId}?razon=${encodeURIComponent(razonCancelacion)}`;

                                        fetch(cancelarUrl)
                                            .then(response => response.json())
                                            .then(data => {
                                                if (data.success) {
                                                    let mensajeExito = data.mensaje;
                                                    let iconoExito = 'success';

                                                    // Personalizar mensaje seg√∫n el tipo de cancelaci√≥n
                                                    if (data.tipo === 'cancelacion_directa') {
                                                        mensajeExito = `
                                <div class="text-start">
                                    <h5 class="text-success mb-3"><i class="fas fa-check-circle"></i> Reserva cancelada exitosamente</h5>
                                    <p><strong>Tipo:</strong> Reserva pendiente</p>
                                    <p><strong>Raz√≥n:</strong> ${razonCancelacion}</p>
                                    <p class="text-muted mb-0">No se aplicaron penalizaciones.</p>
                                </div>
                            `;
                                                    } else if (data.tipo === 'cancelacion_con_reembolso') {
                                                        iconoExito = 'success';
                                                        mensajeExito = `
                                <div class="text-start">
                                    <h5 class="text-success mb-3"><i class="fas fa-check-circle"></i> Reserva cancelada exitosamente</h5>
                                    <p><strong>Tipo:</strong> Reserva confirmada</p>
                                    <p><strong>Raz√≥n:</strong> ${razonCancelacion}</p>
                                    <div class="alert alert-info mt-3 mb-3">
                                        <h6><strong><i class="fas fa-money-bill-wave text-success"></i> Reembolso generado:</strong></h6>
                                        <p class="mb-1"><strong>Monto:</strong> S/ ${data.montoReembolso}</p>
                                        <p class="mb-0"><strong>ID de reembolso:</strong> #${data.reembolsoId}</p>
                                    </div>
                                    <p class="text-muted mb-0">El reembolso ser√° procesado en los pr√≥ximos d√≠as laborables y te notificaremos por email.</p>
                                </div>
                            `;
                                                    } else if (data.tipo === 'cancelacion_sin_reembolso_automatico') {
                                                        iconoExito = 'warning';
                                                        mensajeExito = `
                                <div class="text-start">
                                    <h5 class="text-warning mb-3"><i class="fas fa-exclamation-triangle"></i> Reserva cancelada</h5>
                                    <p><strong>Raz√≥n:</strong> ${razonCancelacion}</p>
                                    <p>${data.mensaje}</p>
                                    <p class="text-muted mb-0">Si necesitas asistencia con el reembolso, contacta con nuestro equipo de soporte.</p>
                                </div>
                            `;
                                                    } else if (data.tipo === 'cancelacion_sin_pago') {
                                                        iconoExito = 'info';
                                                        mensajeExito = `
                                <div class="text-start">
                                    <h5 class="text-info mb-3"><i class="fas fa-info-circle"></i> Reserva cancelada</h5>
                                    <p><strong>Raz√≥n:</strong> ${razonCancelacion}</p>
                                    <p>${data.mensaje}</p>
                                    <p class="text-muted mb-0">Si realizaste un pago, por favor contacta con soporte.</p>
                                </div>
                            `;
                                                    }

                                                    Swal.fire({
                                                        icon: iconoExito,
                                                        title: 'Cancelaci√≥n procesada',
                                                        html: mensajeExito,
                                                        confirmButtonText: 'Aceptar',
                                                        width: '600px',
                                                        customClass: {
                                                            htmlContainer: 'text-start'
                                                        }
                                                    }).then(() => {
                                                        // Cerrar modal y actualizar calendario
                                                        modal.hide();
                                                        calendar.refetchEvents();
                                                    });
                                                } else {
                                                    let iconoError = 'error';
                                                    let tituloError = 'Error al cancelar';
                                                    let textoError = data.error || 'No se pudo cancelar la reserva';

                                                    // Personalizar mensaje seg√∫n el tipo de error
                                                    if (data.tipo === 'tiempo_insuficiente') {
                                                        iconoError = 'warning';
                                                        tituloError = 'Cancelaci√≥n no permitida';
                                                        textoError = `
                                <div class="text-start">
                                    <h5 class="text-warning mb-3"><i class="fas fa-exclamation-triangle"></i> No se puede cancelar</h5>
                                    <p><strong>Raz√≥n solicitada:</strong> ${razonCancelacion}</p>
                                    <div class="alert alert-warning mt-3 mb-3">
                                        <p class="mb-1">No se puede cancelar la reserva confirmada.</p>
                                        <p class="mb-1"><strong>Horas restantes:</strong> ${data.horasRestantes || 'N/A'}</p>
                                        <p class="mb-0">Se requieren al menos 48 horas de anticipaci√≥n.</p>
                                    </div>
                                    <p class="text-muted mb-0">Las reservas confirmadas solo pueden cancelarse con al menos 48 horas de anticipaci√≥n para generar reembolso.</p>
                                </div>
                            `;
                                                    } else if (data.tipo === 'ya_cancelada') {
                                                        iconoError = 'info';
                                                        tituloError = 'Reserva ya cancelada';
                                                        textoError = `
                                <div class="text-start">
                                    <h5 class="text-info mb-3"><i class="fas fa-info-circle"></i> Estado actual</h5>
                                    <p>Esta reserva ya fue cancelada anteriormente.</p>
                                    <p class="text-muted mb-0">No es necesario realizar ninguna acci√≥n adicional.</p>
                                </div>
                            `;
                                                    } else if (data.tipo === 'completada') {
                                                        iconoError = 'info';
                                                        tituloError = 'Cancelaci√≥n no permitida';
                                                        textoError = `
                                <div class="text-start">
                                    <h5 class="text-info mb-3"><i class="fas fa-info-circle"></i> Reserva completada</h5>
                                    <p>No se puede cancelar una reserva que ya ha sido completada.</p>
                                    <p class="text-muted mb-0">La reserva fue utilizada exitosamente.</p>
                                </div>
                            `;
                                                    } else if (data.tipo === 'en_proceso') {
                                                        iconoError = 'info';
                                                        tituloError = 'Cancelaci√≥n no permitida';
                                                        textoError = `
                                <div class="text-start">
                                    <h5 class="text-info mb-3"><i class="fas fa-info-circle"></i> Reserva en proceso</h5>
                                    <p>No se puede cancelar una reserva que est√° en proceso.</p>
                                    <p class="text-muted mb-0">La reserva est√° siendo utilizada actualmente.</p>
                                </div>
                            `;
                                                    }

                                                    Swal.fire({
                                                        icon: iconoError,
                                                        title: tituloError,
                                                        html: textoError,
                                                        confirmButtonText: 'Entendido',
                                                        width: '600px',
                                                        customClass: {
                                                            htmlContainer: 'text-start'
                                                        }
                                                    });
                                                }
                                            })
                                            .catch(error => {
                                                console.error('Error:', error);
                                                Swal.fire({
                                                    icon: 'error',
                                                    title: 'Error de conexi√≥n',
                                                    html: `
                            <div class="text-start">
                                <h5 class="text-danger mb-3"><i class="fas fa-times-circle"></i> Error de conexi√≥n</h5>
                                <p><strong>Raz√≥n solicitada:</strong> ${razonCancelacion}</p>
                                <p class="text-muted mb-0">No se pudo conectar con el servidor. Por favor, intenta nuevamente.</p>
                            </div>
                        `,
                                                    confirmButtonText: 'Aceptar',
                                                    width: '600px'
                                                });
                                            });
                                    }
                                });

                                return false;
                            };

                            // Gestionar bot√≥n "Ver todas mis reservas" y "Completar reserva"
                            const actionsRow = document.querySelector("#view-reservation-details .row");

                            // Verificar si ya existe el bot√≥n "Completar reserva" y borrarlo si existe
                            const existingCompletarBtn = document.getElementById("btn-completar-reserva");
                            if (existingCompletarBtn) {
                                existingCompletarBtn.remove();
                            }

                            // Si la reserva est√° en estado pendiente, mostrar bot√≥n "Completar reserva" y ocultar "Ver todas mis reservas"
                            if (data.estado.toLowerCase() === 'pendiente') {
                                const btnCompletar = document.createElement("a");
                                btnCompletar.id = "btn-completar-reserva";
                                btnCompletar.className = "btn btn-success";
                                btnCompletar.href = `/usuarios/confirmarReserva/${reservaId}`;
                                btnCompletar.textContent = "Completar reserva";
                                actionsRow.querySelector(".text-end").appendChild(btnCompletar);

                                // Ocultar bot√≥n "Ver todas mis reservas"
                                if (btnVerReservas) {
                                    btnVerReservas.style.display = 'none';
                                }
                            } else {
                                // Mostrar bot√≥n "Ver todas mis reservas" para otros estados
                                if (btnVerReservas) {
                                    btnVerReservas.style.display = '';
                                }
                            }

                            // Deshabilitar bot√≥n de cancelar si ya est√° cancelada o completada
                            if (data.estado === 'cancelada' || data.estado === 'completada') {
                                btnCancelar.classList.add('disabled');
                                btnCancelar.setAttribute('aria-disabled', 'true');
                            } else {
                                btnCancelar.classList.remove('disabled');
                                btnCancelar.removeAttribute('aria-disabled');
                            }

                            // Consultar y mostrar informaci√≥n de ocupaci√≥n actual
                            const fechaStr = startDate.toISOString().split('T')[0];
                            const horaStr = startDate.toTimeString().substring(0, 8);
                            console.log(`Consultando ocupaci√≥n para espacioId: ${espacioId}, fecha: ${fechaStr}, hora: ${horaStr}`);

                            fetch(`/api/disponibilidad/gimnasio?espacioId=${espacioId}&fecha=${fechaStr}&hora=${horaStr}`)
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Error al consultar disponibilidad');
                                    }
                                    return response.json();
                                })
                                .then(ocupacionData => {
                                    const ocupacionDiv = document.getElementById("detail-ocupacion");

                                    // Obtener datos
                                    const aforoTotal = ocupacionData.aforoTotal || 20;
                                    const ocupacionActual = ocupacionData.ocupacionActual || 0;
                                    const porcentajeOcupacion = (ocupacionActual / aforoTotal) * 100;

                                    // Determinar estilos y mensaje seg√∫n nivel de ocupaci√≥n
                                    let colorBarra = "bg-success";
                                    let alertClass = "alert-success";
                                    let mensaje = "Ocupaci√≥n baja. ¬°Buena elecci√≥n para entrenar con tranquilidad!";

                                    if (porcentajeOcupacion > 75) {
                                        colorBarra = "bg-danger";
                                        alertClass = "alert-danger";
                                        mensaje = "Ocupaci√≥n alta. El gimnasio estar√° bastante concurrido.";
                                    } else if (porcentajeOcupacion > 50) {
                                        colorBarra = "bg-warning";
                                        alertClass = "alert-warning";
                                        mensaje = "Ocupaci√≥n media. El gimnasio tendr√° una afluencia moderada.";
                                    }

                                    // Construir HTML con la informaci√≥n de ocupaci√≥n
                                    ocupacionDiv.innerHTML = `
                                        <h6>Ocupaci√≥n del horario</h6>
                                        <div class="alert ${alertClass} mb-0">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <strong>${ocupacionActual} de ${aforoTotal} personas</strong>
                                                <span class="badge bg-secondary">${Math.round(porcentajeOcupacion)}% ocupado</span>
                                            </div>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar ${colorBarra}" role="progressbar" 
                                                    style="width: ${porcentajeOcupacion}%" 
                                                    aria-valuenow="${ocupacionActual}" aria-valuemin="0" aria-valuemax="${aforoTotal}">
                                                </div>
                                            </div>
                                            <small class="mt-2 d-block">${mensaje}</small>
                                        </div>
                                    `;
                                })
                                .catch(error => {
                                    console.error('Error al obtener ocupaci√≥n:', error);
                                    const ocupacionDiv = document.getElementById("detail-ocupacion");
                                    ocupacionDiv.innerHTML = `
                                        <h6>Ocupaci√≥n del horario</h6>
                                        <div class="alert alert-warning mb-0">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>No se pudo obtener la informaci√≥n de ocupaci√≥n.</strong> 
                                            <small>Intenta nuevamente m√°s tarde.</small>
                                        </div>
                                    `;
                                });
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('No se pudo cargar los detalles de la reserva');
                        });
                },

                dateClick: function (info) {
                    const clickedTime = info.date;
                    if (clickedTime < now) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Fecha inv√°lida',
                            text: 'No puedes reservar en fechas pasadas.',
                            confirmButtonText: 'Aceptar'
                        });
                        return;
                    }

                    const eventsAtTime = calendar.getEvents().filter(event => {
                        return (event.start <= clickedTime && event.end > clickedTime);
                    });

                    if (eventsAtTime.length > 0) {
                        const eventoConflicto = eventsAtTime[0];

                        // Si es un mantenimiento, mostrar mensaje espec√≠fico
                        if (eventoConflicto.extendedProps && eventoConflicto.extendedProps.esMantenimiento) {
                            const motivo = eventoConflicto.extendedProps.motivo || 'mantenimiento programado';
                            Swal.fire({
                                icon: 'warning',
                                title: 'üîß Gimnasio en Mantenimiento',
                                html: `
                                    <div class="text-center">
                                        <p>El gimnasio no est√° disponible para reservas.</p>
                                        <p><strong>Motivo:</strong> ${motivo}</p>
                                        <hr>
                                        <p class="text-muted small">
                                            <i class="fas fa-clock"></i> 
                                            Selecciona otro horario en el cual realizar tu reserva.
                                        </p>
                                    </div>
                                `,
                                confirmButtonText: 'Entendido',
                                confirmButtonColor: '#6c757d'
                            });
                            return;
                        }

                        const esPropiaReserva = eventoConflicto.extendedProps && eventoConflicto.extendedProps.esPropia;
                        if (esPropiaReserva) {
                            alert(`Ya tienes una reserva activa para esta hora. Puedes ver sus detalles haciendo clic en ella.`);
                        } else {
                            alert(`Este horario ya est√° reservado por otro usuario. Por favor selecciona otro horario.`);
                        }
                        return;
                    }

                    form.reset();

                    // Mostrar formulario de creaci√≥n y ocultar vista de detalles
                    document.getElementById("create-reservation-form").style.display = "block";
                    document.getElementById("view-reservation-details").style.display = "none";

                    const start = new Date(info.date);
                    clickInfo = info;

                    // Configurar hora de inicio
                    document.getElementById("event-start").dataset.raw = toLocalISOString(start);

                    const formattedDate = start.toLocaleDateString('es-PE');
                    const formattedHour = start.toLocaleTimeString('es-PE', {
                        hour: '2-digit', minute: '2-digit', hour12: false
                    });
                    document.getElementById("event-start").value = `${formattedDate} ${formattedHour}`;

                    // Calcular hora de fin (exactamente 1 hora despu√©s)
                    const end = new Date(start);
                    end.setHours(end.getHours() + 1);

                    // Verificar si hay eventos que bloqueen esta hora completa
                    const eventosEnRango = calendar.getEvents().filter(e =>
                        e.start > start && e.start < end
                    );

                    if (eventosEnRango.length > 0) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Horario no disponible',
                            text: 'No hay disponibilidad para una hora completa desde este horario. Por favor selecciona otro horario de inicio.',
                            confirmButtonText: 'Entendido'
                        });
                        return;
                    }

                    // Mostrar un mensaje informativo sobre la duraci√≥n fija
                    const endLabel = document.querySelector('label[for="event-end"]');
                    if (endLabel) {
                        endLabel.textContent = "Hora de fin (duraci√≥n: 1 hora)";
                    }

                    // Configurar el select de hora de fin con la √∫nica opci√≥n disponible (1 hora despu√©s)
                    const endSelect = document.getElementById("event-end");
                    // Ya no es necesario limpiar opciones anteriores

                    // Formatear la hora de fin
                    const formattedEndDate = end.toLocaleDateString('es-PE');
                    const formattedEndHour = end.toLocaleTimeString('es-PE', {
                        hour: '2-digit', minute: '2-digit', hour12: false
                    });

                    // Asignar valor formateado al input
                    endSelect.value = `${formattedEndDate} ${formattedEndHour}`;

                    // Guardar el valor raw para el formulario
                    endSelect.dataset.raw = toLocalISOString(end);

                    // Ya no es necesario deshabilitar el select porque ahora es un input readonly

                    // Obtener precio por hora del espacio
                    const precioPorHora = parseFloat('[[${espacio.precioPorHora != null ? espacio.precioPorHora : "50.00"}]]');

                    // Reiniciar selector de participantes
                    const participantsSelect = document.getElementById("event-participants");
                    participantsSelect.value = "1";

                    // Calcular precio inicial (1 participante)
                    document.getElementById("event-price").value = precioPorHora.toFixed(2);
                    document.getElementById("input-precio-total").value = precioPorHora;

                    // Agregar event listener para actualizar precio al cambiar participantes
                    participantsSelect.onchange = function () {
                        const participantes = parseInt(this.value);
                        const precioTotal = precioPorHora * participantes;
                        document.getElementById("event-price").value = precioTotal.toFixed(2);
                        document.getElementById("input-precio-total").value = precioTotal;
                    };

                    // Consultar disponibilidad para mostrar informaci√≥n de aforo
                    const fechaHora = toLocalISOString(start);
                    obtenerDisponibilidadGimnasio(espacioId, fechaHora);

                    modal.show();
                    modalTitle.textContent = "Crear Reserva (1 hora)";
                    selectedEvent = null;
                }
            };
            const calendar = initializeCalendar(calendarEl, customConfig, horarioApertura, horarioCierre);
            calendar.render();

            // Funci√≥n para controlar la navegaci√≥n
            function controlNavigation() {
                const now = new Date();
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay() + 1); // Lunes de esta semana
                startOfWeek.setHours(0, 0, 0, 0);

                const currentView = calendar.view;
                const viewStart = new Date(currentView.activeStart);

                // Controlar bot√≥n prev
                const prevButton = document.querySelector('.fc-prev-button');
                if (prevButton) {
                    if (viewStart < startOfWeek) {
                        prevButton.disabled = true;
                        prevButton.style.opacity = '0.5';
                        prevButton.style.cursor = 'not-allowed';
                        prevButton.title = 'No se pueden ver semanas pasadas';
                    } else {
                        prevButton.disabled = false;
                        prevButton.style.opacity = '1';
                        prevButton.style.cursor = 'pointer';
                        prevButton.title = 'Semana anterior';
                    }
                }
            }

            // Ejecutar control de navegaci√≥n despu√©s del render
            setTimeout(controlNavigation, 100);

            // Agregar event listener para controlar navegaci√≥n en cada cambio de vista
            calendar.on('datesSet', controlNavigation);

            // Interceptar clics en el bot√≥n prev para prevenir navegaci√≥n a semanas pasadas
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('fc-prev-button') && e.target.disabled) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            });

            // Marcar horarios pasados como no disponibles
            marcarHorariosPasadosComoNoDisponibles(calendar);

            // Actualizar cada minuto
            setInterval(() => marcarHorariosPasadosComoNoDisponibles(calendar), 60000);                // Manejador del submit para crear reserva directamente
            document.getElementById("form-event").addEventListener("submit", function (e) {
                e.preventDefault();

                const rawStart = document.getElementById("event-start").dataset.raw;
                const rawEnd = document.getElementById("event-end").dataset.raw;
                const participantes = document.getElementById("event-participants").value;

                if (!rawStart || !rawEnd || !participantes) {
                    alert("Por favor complete todos los campos requeridos.");
                    return;
                }

                // Verificar disponibilidad antes de enviar
                const btnSave = document.getElementById("btn-save-event");
                const originalText = btnSave.textContent;
                btnSave.disabled = true;
                btnSave.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Verificando...';

                // Verificar disponibilidad con n√∫mero de participantes
                const verificarUrl = `/api/verificar-disponibilidad?espacioId=${espacioId}&inicio=${encodeURIComponent(rawStart)}&fin=${encodeURIComponent(rawEnd)}&participantes=${participantes}`;

                fetch(verificarUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data.disponible) {
                            // Proceder con la reserva
                            document.getElementById("input-espacio-id").value = espacioId;
                            document.getElementById("input-fecha-inicio").value = rawStart;
                            document.getElementById("input-fecha-fin").value = rawEnd;
                            form.submit();
                        } else {
                            // Mostrar mensaje de error espec√≠fico seg√∫n el tipo
                            let icono = 'error';
                            let titulo = 'Horario no disponible';

                            if (data.razon === 'mantenimiento') {
                                icono = 'warning';
                                titulo = 'üîß Mantenimiento Programado';

                                // Mostrar informaci√≥n detallada del mantenimiento
                                let detalleMantenimiento = '';
                                if (data.mantenimientos && data.mantenimientos.length > 0) {
                                    detalleMantenimiento = '<br><br><strong>Detalles:</strong><ul>';
                                    data.mantenimientos.forEach(m => {
                                        const inicio = new Date(m.fechaInicio).toLocaleString('es-PE');
                                        const fin = new Date(m.fechaFin).toLocaleString('es-PE');
                                        detalleMantenimiento += `<li><strong>${m.motivo}</strong><br>üìÖ ${inicio} - ${fin}<br>üîß Estado: ${m.estado}</li>`;
                                    });
                                    detalleMantenimiento += '</ul>';
                                }

                                Swal.fire({
                                    icon: icono,
                                    title: titulo,
                                    html: data.mensaje + detalleMantenimiento,
                                    confirmButtonText: 'Entendido',
                                    confirmButtonColor: '#6c757d'
                                });
                            } else {
                                Swal.fire({
                                    icon: icono,
                                    title: titulo,
                                    text: data.mensaje,
                                    confirmButtonText: 'Entendido'
                                });
                            }

                            // Actualizar calendario para mostrar cambios
                            calendar.refetchEvents();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de conexi√≥n',
                            text: 'No se pudo verificar la disponibilidad. Intente nuevamente.',
                            confirmButtonText: 'Aceptar'
                        });
                    })
                    .finally(() => {
                        // Restaurar bot√≥n
                        btnSave.disabled = false;
                        btnSave.textContent = originalText;
                    });
            });

            // Inicializar tooltips de Bootstrap
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl, {
                    trigger: 'click',
                    placement: 'left',
                    html: true
                });
            });

            // Cerrar tooltip al hacer clic fueraF
            document.addEventListener('click', function (e) {
                if (!e.target.closest('[data-bs-toggle="tooltip"]')) {
                    tooltipList.forEach(tooltip => tooltip.hide());
                }
            });
        });

        // Funci√≥n para obtener string local en formato YYYY-MM-DDTHH:mm:ss
        function toLocalISOString(date) {
            const pad = n => n < 10 ? '0' + n : n;
            return date.getFullYear() + '-' +
                pad(date.getMonth() + 1) + '-' +
                pad(date.getDate()) + 'T' +
                pad(date.getHours()) + ':' +
                pad(date.getMinutes()) + ':' +
                pad(date.getSeconds());
        }

        // Funci√≥n para obtener disponibilidad del gimnasio
        function obtenerDisponibilidadGimnasio(espacioId, fechaHora) {
            const fecha = fechaHora.split('T')[0];
            const hora = fechaHora.split('T')[1];

            // Mostrar indicador de carga
            const disponibilidadEl = document.getElementById("gimnasio-disponibilidad");
            disponibilidadEl.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Consultando disponibilidad...</p></div>';

            // Realizar petici√≥n al servidor
            fetch(`/api/disponibilidad/gimnasio?espacioId=${espacioId}&fecha=${fecha}&hora=${hora}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al consultar disponibilidad');
                    }
                    return response.json();
                })
                .then(data => {
                    // Limpiar contenedor
                    disponibilidadEl.innerHTML = '';

                    // Crear elemento de informaci√≥n
                    const disponibilidadInfo = document.createElement("div");
                    disponibilidadInfo.className = "alert mb-0";

                    // Obtener datos
                    const aforoTotal = data.aforoTotal || 20;
                    const ocupacionActual = data.ocupacionActual || 0;
                    const espaciosDisponibles = aforoTotal - ocupacionActual;
                    const porcentajeOcupacion = (ocupacionActual / aforoTotal) * 100;

                    // Determinar estilo seg√∫n ocupaci√≥n
                    let colorBarra = "bg-success";
                    let colorTexto = "text-success";
                    let icono = "fa-check-circle";

                    if (porcentajeOcupacion > 75) {
                        colorBarra = "bg-danger";
                        colorTexto = "text-danger";
                        icono = "fa-exclamation-circle";
                        disponibilidadInfo.className = "alert alert-danger mb-0";
                    } else if (porcentajeOcupacion > 50) {
                        colorBarra = "bg-warning";
                        colorTexto = "text-warning";
                        icono = "fa-exclamation-triangle";
                        disponibilidadInfo.className = "alert alert-warning mb-0";
                    } else {
                        disponibilidadInfo.className = "alert alert-success mb-0";
                    }

                    // Limitar participantes seg√∫n disponibilidad
                    const participantsSelect = document.getElementById("event-participants");
                    participantsSelect.innerHTML = ''; // Limpiar opciones

                    // Agregar opciones seg√∫n espacios disponibles (m√°ximo 5)
                    const maxParticipantes = Math.min(espaciosDisponibles, 5);
                    for (let i = 1; i <= maxParticipantes; i++) {
                        const option = document.createElement("option");
                        option.value = i;
                        option.textContent = i === 1 ? "1 persona" : i + " personas";
                        participantsSelect.appendChild(option);
                    }

                    // Si no hay espacio, mostrar mensaje y deshabilitar bot√≥n
                    if (espaciosDisponibles <= 0) {
                        disponibilidadInfo.innerHTML = `
                                <i class="fas fa-times-circle me-2"></i>
                                <strong>No hay disponibilidad:</strong> El aforo est√° completo para este horario.
                            `;
                        document.getElementById("btn-save-event").disabled = true;
                        document.getElementById("btn-save-event").classList.add("disabled");
                    } else {
                        disponibilidadInfo.innerHTML = `
                                <i class="fas ${icono} me-2 ${colorTexto}"></i>
                                <strong>Disponibilidad actual:</strong> ${espaciosDisponibles} de ${aforoTotal} espacios disponibles
                                <div class="progress mt-2" style="height: 8px;">
                                    <div class="progress-bar ${colorBarra}" role="progressbar" 
                                        style="width: ${porcentajeOcupacion}%" 
                                        aria-valuenow="${ocupacionActual}" aria-valuemin="0" aria-valuemax="${aforoTotal}">
                                    </div>
                                </div>
                            `;

                        // Habilitar bot√≥n de guardar
                        document.getElementById("btn-save-event").disabled = false;
                        document.getElementById("btn-save-event").classList.remove("disabled");
                    }

                    disponibilidadEl.appendChild(disponibilidadInfo);
                })
                .catch(error => {
                    console.error('Error al obtener disponibilidad:', error);

                    const errorInfo = document.createElement("div");
                    errorInfo.className = "alert alert-warning mb-0";
                    errorInfo.innerHTML = `
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Error al verificar disponibilidad:</strong> ${error.message || 'Intenta nuevamente'}
                        `;

                    disponibilidadEl.innerHTML = '';
                    disponibilidadEl.appendChild(errorInfo);
                });
        }

        // Agregar esta funci√≥n para obtener el precio por hora de manera segura
        function getPrecioPorHora() {
            // Intentar obtener desde el modelo del servidor via Thymeleaf
            const precioPorHoraElement = document.querySelector('[data-precio-por-hora]');
            if (precioPorHoraElement && precioPorHoraElement.dataset.precioPorHora) {
                return parseFloat(precioPorHoraElement.dataset.precioPorHora);
            }

            // Intentar obtener desde el texto mostrado en la p√°gina
            const precioPorHoraText = document.querySelector('.text-success.fw-bold span');
            if (precioPorHoraText) {
                const precio = parseFloat(precioPorHoraText.textContent.trim());
                if (!isNaN(precio)) {
                    return precio;
                }
            }

            // Valor por defecto si no se encuentra
            return 50.0;
        }
    </script>
</body>

</html>
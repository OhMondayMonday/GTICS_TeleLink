<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{Vecino/fragments/topbarVecino.html :: head(title='Canchas disponibles')}"></head>

<body data-sidebar="dark" class="vertical-collpsed">
<!-- Begin page -->
<div id="layout-wrapper">
    <div th:replace="~{Vecino/fragments/topbarVecino :: topbar('Canchas disponibles')}"></div>
    <!-----------------------------------------------------------------------MENU-------------------------------------------------------------------------->
    <div th:replace="~{Vecino/fragments/sidebarVecino :: sidebar('canchas')}"></div>
    <!-- ============================================================================================================================= -->
    <div class="main-content">
        <div class="page-content">
            <div class="container-fluid">
                <div th:if="${mensaje}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <span th:text="${mensaje}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <span th:text="${error}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <!-- end page title -->
                <div class="row">
                    <div class="col-xl-3 col-lg-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="font-size-14 mb-0">Filtrar por</h5>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limpiarFiltros()">
                                        <i class="mdi mdi-refresh me-1"></i>Limpiar filtros
                                    </button>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div>
                                            <h5 id="servicios-title">Servicios Deportivos</h5>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="search-box">
                                            <div class="position-relative">
                                                <input type="text"
                                                       class="form-control"
                                                       placeholder="Buscar espacios deportivos..."
                                                       id="search-input">
                                                <i class="mdi mdi-magnify search-icon"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="accordion" id="accordionCanchaFiltros">
                                    <!-- Servicios deportivos -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="serviciosHeading">
                                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseServicios" aria-expanded="true" aria-controls="collapseServicios">
                                                <i class="mdi mdi-soccer font-size-16 align-middle me-2"></i> Servicios deportivos
                                            </button>
                                        </h2>
                                        <div id="collapseServicios" class="accordion-collapse collapse show" aria-labelledby="serviciosHeading" data-bs-parent="#accordionCanchaFiltros">
                                            <div class="accordion-body">
                                                <ul class="list-unstyled categories-list mb-0">
                                                    <li><input type="checkbox" id="futbol-loza"> <label for="futbol-loza">Cancha de fútbol (Loza)</label></li>
                                                    <li><input type="checkbox" id="futbol-grass"> <label for="futbol-grass">Cancha de fútbol (Grass sintético)</label></li>
                                                    <li><input type="checkbox" id="gimnasio"> <label for="gimnasio">Gimnasio</label></li>
                                                    <li><input type="checkbox" id="piscina"> <label for="piscina">Piscina</label></li>
                                                    <li><input type="checkbox" id="atletismo"> <label for="atletismo">Pista de atletismo</label></li>
                                                    <li><input type="checkbox" id="multiusos"> <label for="atletismo">Cancha Multiusos</label></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Precio -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="precioHeading">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePrecio" aria-expanded="false" aria-controls="collapsePrecio">
                                                <i class="mdi mdi-currency-usd font-size-16 align-middle me-2"></i> Precio (S/)
                                            </button>
                                        </h2>
                                        <div id="collapsePrecio" class="accordion-collapse collapse show" aria-labelledby="precioHeading" data-bs-parent="#accordionCanchaFiltros">
                                            <div class="accordion-body">
                                                <label for="precioRange" class="form-label">Rango de precios:</label>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span id="precioMin">S/ 10</span>
                                                    <span id="precioMax">S/ 150</span>
                                                </div>
                                                <input type="range" class="form-range" min="10" max="150" step="5" id="precioRange" oninput="actualizarPrecio(this.value)">
                                                <div class="text-center mt-2">
                                                    <strong>Seleccionado: <span id="precioActual">S/ 80</span></strong>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <script>
                                        function actualizarPrecio(valor) {
                                            document.getElementById('precioActual').innerText = 'S/ ' + valor;

                                            // Verificar si la función aplicarFiltros existe antes de llamarla
                                            if (typeof aplicarFiltros === 'function') {
                                                // Aplicamos los filtros con un pequeño retraso para mejorar rendimiento
                                                clearTimeout(window.filtroTimeout);
                                                window.filtroTimeout = setTimeout(aplicarFiltros, 300);
                                            }
                                        }
                                    </script>
                                    
                                    <!-- Calificación -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="ratingHeading">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRating" aria-expanded="false" aria-controls="collapseRating">
                                                <i class="mdi mdi-star-outline font-size-16 align-middle me-2"></i> Calificación
                                            </button>
                                        </h2>
                                        <div id="collapseRating" class="accordion-collapse collapse" aria-labelledby="ratingHeading" data-bs-parent="#accordionCanchaFiltros">
                                            <div class="accordion-body">
                                                <div class="form-check mb-2">
                                                    <input type="radio" name="rating" id="rating4" class="form-check-input">
                                                    <label class="form-check-label" for="rating4">4 estrellas o más</label>
                                                </div>
                                                <div class="form-check mb-2">
                                                    <input type="radio" name="rating" id="rating3" class="form-check-input">
                                                    <label class="form-check-label" for="rating3">3 estrellas o más</label>
                                                </div>
                                                <div class="form-check mb-2">
                                                    <input type="radio" name="rating" id="rating2" class="form-check-input">
                                                    <label class="form-check-label" for="rating2">2 estrellas o más</label>
                                                </div>
                                                <div class="form-check mb-2">
                                                    <input type="radio" name="rating" id="rating1" class="form-check-input">
                                                    <label class="form-check-label" for="rating1">1 estrella o más</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-9">
                        <div class="card">
                            <div class="card-body">
                                <div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div>
                                                <h5 id="servicios-contador">Servicios Deportivos</h5>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="float-end">
                                                <div class="d-flex align-items-center">
                                                    <p class="page-info mb-0 me-3">Página <span class="fw-bold">1</span> de <span class="fw-bold">1</span></p>
                                                    <ul class="pagination pagination-rounded mb-0 pagination-container"></ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-----==================================================================================================================================---->
                                    <!-- SECCIÓN ESTÁTICA - Solo se muestra al cargar la página inicialmente -->
                                    <div id="espacios-estaticos" class="row g-0">
                                        <div class="col-xl-4 col-sm-6" th:each="espacio : ${espacios}">
                                            <div class="product-box">
                                                <div class="product-img position-relative">
                                                    <!-- Estado -->
                                                    <div th:if="${espacio.estadoServicio.name() == 'operativo'}"
                                                         class="product-ribbon badge bg-success">Disponible</div>
                                                    <div th:if="${espacio.estadoServicio.name() == 'mantenimiento'}"
                                                         class="product-ribbon badge bg-warning">En Mantenimiento</div>
                                                    <div th:if="${espacio.estadoServicio.name() == 'clausurado'}"
                                                         class="product-ribbon badge bg-danger">Clausurado</div>

                                                    <!-- Tipo -->
                                                    <span class="badge bg-info position-absolute top-0 end-0 m-2"
                                                          th:text="${espacio.servicioDeportivo.servicioDeportivo}">Tipo</span>

                                                    <!-- Imagen -->
                                                    <img th:src="@{${espacio.fotoEspacioDeportivoUrl}}"
                                                         alt="espacio" class="img-fluid mx-auto d-block"
                                                         style="height: 220px; object-fit: cover;">
                                                </div>

                                                <div class="text-center p-2">
                                                    <p class="font-size-12 mb-1"
                                                       th:text="${espacio.descripcion}">Descripción</p>

                                                    <h5 class="font-size-15">
                                                        <a href="#" class="text-reset"
                                                           th:text="${espacio.nombre}">Nombre espacio</a>
                                                    </h5>

                                                    <!-- Detalles personalizados -->
                                                    <div th:switch="${espacio.servicioDeportivo.servicioDeportivo}">
                                                        <p class="mb-1" th:case="'Piscina'">Carriles:
                                                            <span th:text="${espacio.carrilesPiscina}">4</span>,
                                                            Longitud: <span th:text="${espacio.longitudPiscina}">50</span> m
                                                        </p>
                                                        <p class="mb-1" th:case="'Gimnasio'">Aforo:
                                                            <span th:text="${espacio.aforoGimnasio}">30</span> personas
                                                        </p>
                                                        <p class="mb-1" th:case="'Pista de Atletismo'">Carriles:
                                                            <span th:text="${espacio.carrilesPista}">8</span>,
                                                            Longitud: <span th:text="${espacio.longitudPista}">400</span> m
                                                        </p>
                                                        <p class="mb-1" th:case="*">Capacidad:
                                                            <span th:text="${espacio.maxPersonasPorCarril != null ? espacio.maxPersonasPorCarril : 1}">1</span> persona
                                                        </p>
                                                    </div>

                                                    <!-- Precio -->
                                                    <p class="mb-1">Precio:
                                                        S/ <span th:text="${#numbers.formatDecimal(espacio.precioPorHora, 1, 'POINT', 2, 'POINT')}">00.00</span>
                                                    </p>

                                                    <!-- Botón -->
                                                    <div class="d-flex justify-content-center gap-2 mt-2">
                                                        <a th:href="@{'/usuarios/reservas/' + ${espacio.espacioDeportivoId}}"
                                                           class="btn btn-sm btn-outline-info">
                                                            <i class="fas fa-eye me-1"></i> Ver detalles
                                                        </a>
                                                        <a th:href="@{'/usuarios/reservasCalendario/' + ${espacio.espacioDeportivoId}}"
                                                           class="btn btn-sm btn-primary">
                                                            <i class="fas fa-calendar-check me-1"></i> Reservar
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-----==================================================================================================================================---->

                                    <!-- CONTENEDOR DINÁMICO - Se muestra cuando se aplican filtros -->
                                    <div id="tarjetas-container" class="row g-0" style="display: none;"></div>

                                    <!-- PAGINACIÓN -->
                                    <div class="row mt-4">
                                        <div class="col-12">
                                            <div class="d-flex justify-content-center">
                                                <p id="page-info" class="page-info mb-0 me-3">Página <span class="fw-bold">1</span> de <span class="fw-bold">1</span></p>
                                                <ul id="pagination" class="pagination pagination-rounded mb-0 pagination-container"></ul>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- SCRIPT PARA PAGINAR TARJETAS -->
                                    <script>

                                        let tarjetas = [];

                                        fetch("/espacios")
                                            .then(res => res.json())
                                            .then(data => {
                                                tarjetas = data.map(e => ({
                                                    titulo: e.nombre,
                                                    descripcion: e.descripcion || "Espacio deportivo disponible.",
                                                    capacidad: e.aforoGimnasio || e.maxPersonasPorCarril || "No definido",
                                                    precio: `S/ ${e.precioPorHora || 0}`,
                                                    tipo: mapTipo(e.servicioDeportivo?.nombre),
                                                    imagen: seleccionarImagen(e.nombre),
                                                    enlace: `vecino-${slug(e.nombre)}.html`,
                                                    horario: formatHorario(e.horarioApertura, e.horarioCierre),
                                                    caracteristicas: []
                                                }));

                                                mostrarTarjetas();
                                                mostrarContadorResultados(tarjetas.length);
                                            });


                                        // Variables para la paginación y filtrado
                                        const tarjetasPorPagina = 6;
                                        let paginaActual = 1;
                                        let tarjetasActuales = [...tarjetas];

                                        // Actualizar la función aplicarFiltros para enviar los filtros al backend
                                        function aplicarFiltros() {
                                            const textoBusqueda = document.querySelector('.search-box input')?.value.toLowerCase().trim() || '';

                                            // Recopilar filtros de servicios deportivos
                                            const serviciosSeleccionados = [];
                                            if (document.getElementById('futbol-loza')?.checked) serviciosSeleccionados.push('futbol-loza');
                                            if (document.getElementById('futbol-grass')?.checked) serviciosSeleccionados.push('futbol-grass');
                                            if (document.getElementById('gimnasio')?.checked) serviciosSeleccionados.push('gimnasio');
                                            if (document.getElementById('piscina')?.checked) serviciosSeleccionados.push('piscina');
                                            if (document.getElementById('atletismo')?.checked) serviciosSeleccionados.push('atletismo');
                                            if (document.getElementById('multiusos')?.checked) serviciosSeleccionados.push('multiusos');

                                            // Recopilar filtros de zonas
                                            const zonasSeleccionadas = [];
                                            if (document.getElementById('zona-costado')?.checked) zonasSeleccionadas.push('zona-costado');
                                            if (document.getElementById('zona-avla-marina')?.checked) zonasSeleccionadas.push('zona-avla-marina');
                                            if (document.getElementById('zona-parque-zonal')?.checked) zonasSeleccionadas.push('zona-parque-zonal');
                                            if (document.getElementById('zona-plaza-sanmiguel')?.checked) zonasSeleccionadas.push('zona-plaza-sanmiguel');
                                            if (document.getElementById('zona-univcatolica')?.checked) zonasSeleccionadas.push('zona-univcatolica');

                                            const precioMaximo = document.getElementById('precioRange')?.value || 150;

                                            // Verificar si hay filtros activos
                                            const hayFiltrosActivos = textoBusqueda !== '' ||
                                                serviciosSeleccionados.length > 0 ||
                                                zonasSeleccionadas.length > 0 ||
                                                parseInt(precioMaximo) < 150;

                                            // Si no hay filtros activos, mostrar la sección estática y ocultar la dinámica
                                            if (!hayFiltrosActivos) {
                                                document.getElementById('espacios-estaticos').style.display = 'flex';
                                                document.getElementById('tarjetas-container').style.display = 'none';
                                                document.getElementById('page-info').style.display = 'none';
                                                document.getElementById('pagination').style.display = 'none';
                                                return;
                                            }

                                            // Construir parámetros de la URL
                                            const params = new URLSearchParams();
                                            if (serviciosSeleccionados.length > 0) params.append('servicios', serviciosSeleccionados.join(','));
                                            if (zonasSeleccionadas.length > 0) params.append('zonas', zonasSeleccionadas.join(','));
                                            params.append('precioMaximo', precioMaximo);
                                            if (textoBusqueda !== '') params.append('busqueda', textoBusqueda);

                                            // Hacer petición AJAX al backend
                                            fetch(`/usuarios/espacios?${params.toString()}`)
                                                .then(response => response.json())
                                                .then(data => {
                                                    // Ocultar la sección estática y mostrar la dinámica
                                                    document.getElementById('espacios-estaticos').style.display = 'none';
                                                    document.getElementById('tarjetas-container').style.display = 'flex';
                                                    document.getElementById('page-info').style.display = 'block';
                                                    document.getElementById('pagination').style.display = 'block';

                                                    // Actualizar las tarjetas con los datos filtrados
                                                    tarjetas = data.map(espacio => mapearEspacioATarjeta(espacio));
                                                    tarjetasActuales = [...tarjetas];
                                                    paginaActual = 1;
                                                    mostrarTarjetas();
                                                    mostrarContadorResultados(tarjetasActuales.length);
                                                })
                                                .catch(error => {
                                                    console.error('Error al filtrar espacios:', error);
                                                });
                                        }
                                        // Función para mapear los datos del backend a formato de tarjeta
                                        function mapearEspacioATarjeta(espacio) {
                                            return {
                                                titulo: espacio.nombre,
                                                descripcion: espacio.descripcion || "Espacio deportivo disponible.",
                                                capacidad: obtenerCapacidad(espacio),
                                                precio: `S/ ${espacio.precioPorHora}`,
                                                tipo: mapearTipoServicio(espacio.servicioDeportivo.servicioDeportivo),
                                                imagen: espacio.fotoEspacioDeportivoUrl || '/api/placeholder/400/320',
                                                enlace: `/usuarios/reservasCalendario/${espacio.espacioDeportivoId}`,
                                                horario: formatearHorario(espacio.horarioApertura, espacio.horarioCierre),
                                                caracteristicas: obtenerCaracteristicas(espacio),
                                                estado: espacio.estadoServicio,
                                                espacioId: espacio.espacioDeportivoId
                                            };
                                        }

                                        // Función para obtener la capacidad según el tipo de espacio
                                        function obtenerCapacidad(espacio) {
                                            if (espacio.aforoGimnasio) return `${espacio.aforoGimnasio} personas`;
                                            if (espacio.maxPersonasPorCarril) return `${espacio.maxPersonasPorCarril} personas/carril`;
                                            if (espacio.carrilesPiscina) return `${espacio.carrilesPiscina} carriles`;
                                            if (espacio.carrilesPista) return `${espacio.carrilesPista} carriles`;
                                            return "No especificado";
                                        }

                                        // Función para mapear tipos de servicio
                                        function mapearTipoServicio(servicioDeportivo) {
                                            const servicio = servicioDeportivo.toLowerCase();
                                            if (servicio.includes('fútbol')) {
                                                if (servicio.includes('loza')) return 'Fútbol - Loza';
                                                if (servicio.includes('grass') || servicio.includes('sintético')) return 'Fútbol - Grass';
                                                return 'Fútbol';
                                            }
                                            if (servicio.includes('gimnasio')) return 'Gimnasio';
                                            if (servicio.includes('piscina')) return 'Piscina';
                                            if (servicio.includes('atletismo') || servicio.includes('pista')) return 'Atletismo';
                                            if (servicio.includes('multiusos') || servicio.includes('multifuncional')) return 'Multifuncional';
                                            return servicioDeportivo;
                                        }

                                        // Función para formatear horarios
                                        function formatearHorario(apertura, cierre) {
                                            if (!apertura || !cierre) return 'Horario flexible';
                                            return `${apertura} - ${cierre}`;
                                        }

                                        // Función para obtener características específicas del espacio
                                        function obtenerCaracteristicas(espacio) {
                                            const caracteristicas = [];

                                            if (espacio.carrilesPiscina) {
                                                caracteristicas.push(`${espacio.carrilesPiscina} carriles`);
                                                if (espacio.longitudPiscina) caracteristicas.push(`${espacio.longitudPiscina}m de largo`);
                                            }

                                            if (espacio.carrilesPista) {
                                                caracteristicas.push(`${espacio.carrilesPista} carriles`);
                                                if (espacio.longitudPista) caracteristicas.push(`${espacio.longitudPista}m de largo`);
                                            }

                                            if (espacio.establecimientoDeportivo?.espaciosEstacionamiento) {
                                                caracteristicas.push('Estacionamiento disponible');
                                            }

                                            return caracteristicas;
                                        }


                                        // Función para mostrar contador de resultados
                                        function mostrarContadorResultados(cantidad) {
                                            const infoElement = document.getElementById('servicios-contador');
                                            if (infoElement) {
                                                infoElement.innerHTML = `Servicios Deportivos <span class="badge bg-primary">${cantidad} resultados</span>`;
                                            }
                                        }

                                        function limpiarFiltros() {
                                            // Limpiar checkboxes
                                            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                                            checkboxes.forEach(cb => cb.checked = false);

                                            // Limpiar radio buttons de rating
                                            const radios = document.querySelectorAll('input[name="rating"]');
                                            radios.forEach(radio => radio.checked = false);

                                            // Resetear rango de precio
                                            const precioRange = document.getElementById('precioRange');
                                            if (precioRange) {
                                                precioRange.value = 150;
                                                document.getElementById('precioActual').innerText = 'S/ 150';
                                            }

                                            // Limpiar búsqueda
                                            const inputBusqueda = document.querySelector('.search-box input');
                                            if (inputBusqueda) {
                                                inputBusqueda.value = '';
                                            }

                                            // CAMBIO IMPORTANTE: Mostrar todas las tarjetas originales con paginación
                                            // en lugar de simplemente mostrar la sección estática
                                            fetch("/espacios")
                                                .then(res => res.json())
                                                .then(data => {
                                                    tarjetas = data.map(e => ({
                                                        titulo: e.nombre,
                                                        descripcion: e.descripcion || "Espacio deportivo disponible.",
                                                        capacidad: e.aforoGimnasio || e.maxPersonasPorCarril || "No definido",
                                                        precio: `S/ ${e.precioPorHora || 0}`,
                                                        tipo: mapTipo(e.servicioDeportivo?.nombre),
                                                        imagen: seleccionarImagen(e.nombre),
                                                        enlace: `vecino-${slug(e.nombre)}.html`,
                                                        horario: formatHorario(e.horarioApertura, e.horarioCierre),
                                                        caracteristicas: []
                                                    }));

                                                    tarjetasActuales = [...tarjetas];
                                                    paginaActual = 1;

                                                    // Ocultar sección estática y mostrar la paginada
                                                    document.getElementById('espacios-estaticos').style.display = 'none';
                                                    document.getElementById('tarjetas-container').style.display = 'flex';
                                                    document.getElementById('page-info').style.display = 'block';
                                                    document.getElementById('pagination').style.display = 'block';

                                                    // Mostrar las tarjetas paginadas
                                                    mostrarTarjetas();
                                                    mostrarContadorResultados(tarjetasActuales.length);
                                                })
                                                .catch(error => {
                                                    console.error('Error al cargar espacios:', error);
                                                    // En caso de error, mostrar la sección estática como fallback
                                                    document.getElementById('espacios-estaticos').style.display = 'flex';
                                                    document.getElementById('tarjetas-container').style.display = 'none';
                                                    document.getElementById('page-info').style.display = 'none';
                                                    document.getElementById('pagination').style.display = 'none';
                                                });

                                            // Resetear contador
                                            const infoElement = document.getElementById('servicios-contador');
                                            if (infoElement) {
                                                infoElement.innerHTML = 'Servicios Deportivos';
                                            }

                                            // Restaurar estado de los acordeones
                                            const collapses = document.querySelectorAll('.accordion-collapse');
                                            collapses.forEach(collapse => {
                                                collapse.classList.add('show');
                                                const button = document.querySelector(`[data-bs-target="#${collapse.id}"]`);
                                                if (button) {
                                                    button.classList.remove('collapsed');
                                                    button.setAttribute('aria-expanded', 'true');
                                                }
                                            });
                                        }

                                        // Modificar la función mostrarTarjetas para manejar estados
                                        function mostrarTarjetas() {
                                            const inicio = (paginaActual - 1) * tarjetasPorPagina;
                                            const fin = inicio + tarjetasPorPagina;
                                            const tarjetasPagina = tarjetasActuales.slice(inicio, fin);

                                            const contenedor = document.getElementById("tarjetas-container");
                                            contenedor.innerHTML = "";

                                            if (tarjetasPagina.length === 0) {
                                                contenedor.innerHTML = `
                                                    <div class="col-12 text-center p-5">
                                                        <i class="mdi mdi-soccer font-size-48 text-muted mb-3"></i>
                                                        <h4>No se encontraron espacios deportivos</h4>
                                                        <p class="text-muted">Intenta cambiar los filtros o ajustar el rango de precios.</p>
                                                    </div>
                                                `;
                                            } else {
                                                tarjetasPagina.forEach(tarjeta => {
                                                    let badgeClass = "bg-info";
                                                    let estadoBadge = "";

                                                    // Asignar clases según el tipo
                                                    if (tarjeta.tipo.includes("Fútbol")) badgeClass = "bg-warning";
                                                    else if (tarjeta.tipo === "Atletismo") badgeClass = "bg-danger";
                                                    else if (tarjeta.tipo === "Multifuncional") badgeClass = "bg-secondary";

                                                    // Asignar badge de estado
                                                    if (tarjeta.estado === 'operativo') {
                                                        estadoBadge = '<div class="product-ribbon badge bg-success">Disponible</div>';
                                                    } else if (tarjeta.estado === 'mantenimiento') {
                                                        estadoBadge = '<div class="product-ribbon badge bg-warning">En Mantenimiento</div>';
                                                    } else if (tarjeta.estado === 'clausurado') {
                                                        estadoBadge = '<div class="product-ribbon badge bg-danger">Clausurado</div>';
                                                    }

                                                    // Crear lista de características
                                                    let caracteristicasHTML = '';
                                                    if (tarjeta.caracteristicas && tarjeta.caracteristicas.length > 0) {
                                                        caracteristicasHTML = '<div class="mt-2 mb-2"><small class="text-muted">';
                                                        caracteristicasHTML += tarjeta.caracteristicas.map(c =>
                                                            `<i class="mdi mdi-check-circle text-success me-1"></i>${c}`
                                                        ).join(' • ');
                                                        caracteristicasHTML += '</small></div>';
                                                    }

                                                    // Extraer el ID del espacio desde la URL de reserva
                                                    const espacioId = tarjeta.enlace.split('/').pop();

                                                    contenedor.innerHTML += `
                                                                                    <div class="col-xl-4 col-sm-6 mb-3">
                                                                                        <div class="product-box border p-3 rounded shadow-sm">
                                                                                            <div class="product-img position-relative">
                                                                                                ${estadoBadge}
                                                                                                <span class="badge ${badgeClass} position-absolute top-0 end-0 m-2">${tarjeta.tipo}</span>
                                                                                                <img src="${tarjeta.imagen}" alt="${tarjeta.titulo}"
                                                                                                     class="img-fluid mx-auto d-block"
                                                                                                     style="height: 220px; object-fit: cover;">
                                                                                            </div>
                                                                                            <div class="text-center p-2">
                                                                                                <h5 class="font-size-16 mt-3">
                                                                                                    <a href="#" class="text-reset">${tarjeta.titulo}</a>
                                                                                                </h5>
                                                                                                <p class="text-muted mb-2">${tarjeta.descripcion}</p>
                                                                                                ${caracteristicasHTML}
                                                                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                                                                    <span><i class="mdi mdi-account-group me-1"></i> ${tarjeta.capacidad}</span>
                                                                                                    <span><i class="mdi mdi-clock-outline me-1"></i> ${tarjeta.horario}</span>
                                                                                                </div>
                                                                                                <div class="d-flex justify-content-between align-items-center">
                                                                                                    <h5 class="text-primary">${tarjeta.precio}</h5>
                                                                                                </div>
                                                                                                <!-- BOTONES MODIFICADOS -->
                                                                                                <div class="d-flex justify-content-center gap-2 mt-2">
                                                                                                    <a href="/usuarios/reservas/${espacioId}" class="btn btn-outline-info btn-sm">
                                                                                                        <i class="fas fa-eye me-1"></i> Ver detalles
                                                                                                    </a>
                                                                                                    <a href="${tarjeta.enlace}" class="btn btn-primary btn-sm">
                                                                                                        <i class="fas fa-calendar-check me-1"></i> Reservar
                                                                                                    </a>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                `;
                                                });
                                            }

                                            actualizarPaginacion();
                                        }

                                        // 2. Función para generar la paginación y colocarla arriba y abajo de las tarjetas
                                        function actualizarPaginacion() {
                                            const totalPaginas = Math.ceil(tarjetasActuales.length / tarjetasPorPagina);
                                            // Seleccionamos ambos contenedores de paginación (arriba y abajo)
                                            const paginacionElementos = document.querySelectorAll(".pagination-container");
                                            const pageInfoElementos = document.querySelectorAll(".page-info");

                                            // Si no hay páginas, mostrar página 0 de 0
                                            if (totalPaginas === 0) {
                                                pageInfoElementos.forEach(info => {
                                                    info.innerHTML = `Página <span class="fw-bold">0</span> de <span class="fw-bold">0</span>`;
                                                });
                                                paginacionElementos.forEach(paginacion => {
                                                    paginacion.innerHTML = '';
                                                });
                                                return;
                                            }

                                            // Actualizar todos los indicadores de página
                                            pageInfoElementos.forEach(info => {
                                                info.innerHTML = `Página <span class="fw-bold">${paginaActual}</span> de <span class="fw-bold">${totalPaginas}</span>`;
                                            });

                                            // Actualizar la paginación en todos los contenedores
                                            paginacionElementos.forEach(paginacion => {
                                                paginacion.innerHTML = `
                                                <li class="page-item ${paginaActual === 1 ? 'disabled' : ''}">
                                                    <a href="#" class="page-link" onclick="cambiarPagina(${paginaActual - 1}); return false;"><i class="mdi mdi-chevron-left"></i></a>
                                                </li>
                                            `;

                                                // Mostrar máximo 5 páginas en la paginación
                                                const maxPaginas = 5;
                                                let startPage = Math.max(1, paginaActual - Math.floor(maxPaginas / 2));
                                                let endPage = Math.min(totalPaginas, startPage + maxPaginas - 1);

                                                if (endPage - startPage + 1 < maxPaginas) {
                                                    startPage = Math.max(1, endPage - maxPaginas + 1);
                                                }

                                                for (let i = startPage; i <= endPage; i++) {
                                                    paginacion.innerHTML += `
                                                    <li class="page-item ${i === paginaActual ? 'active' : ''}">
                                                        <a href="#" class="page-link" onclick="cambiarPagina(${i}); return false;">${i}</a>
                                                    </li>
                                                `;
                                                }

                                                paginacion.innerHTML += `
                                                <li class="page-item ${paginaActual === totalPaginas ? 'disabled' : ''}">
                                                    <a href="#" class="page-link" onclick="cambiarPagina(${paginaActual + 1}); return false;"><i class="mdi mdi-chevron-right"></i></a>
                                                </li>
                                            `;
                                            });
                                        }


                                        // 3. Función para cambiar de página
                                        function cambiarPagina(nuevaPagina) {
                                            const totalPaginas = Math.ceil(tarjetasActuales.length / tarjetasPorPagina);
                                            if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas) {
                                                paginaActual = nuevaPagina;
                                                mostrarTarjetas();
                                                // Scroll suave hacia arriba del contenedor de tarjetas
                                                //document.getElementById('tarjetas-container').scrollIntoView({behavior: 'smooth'});
                                            }
                                            return false; // Para evitar que la página se recargue
                                        }
                                        // Función para búsqueda por texto
                                        function buscarTexto() {
                                            const textoBusqueda = document.querySelector('.search-box input').value.toLowerCase().trim();

                                            // Restaurar todas las tarjetas si no hay texto de búsqueda
                                            if (textoBusqueda === '') {
                                                tarjetasActuales = [...tarjetas];
                                                aplicarFiltros(); // Aplicar los otros filtros
                                                return;
                                            }

                                            // Filtrar por texto en todas las propiedades relevantes
                                            tarjetasActuales = tarjetas.filter(tarjeta => {
                                                return tarjeta.titulo.toLowerCase().includes(textoBusqueda) ||
                                                    tarjeta.descripcion.toLowerCase().includes(textoBusqueda) ||
                                                    tarjeta.tipo.toLowerCase().includes(textoBusqueda) ||
                                                    (tarjeta.caracteristicas && tarjeta.caracteristicas.some(c => c.toLowerCase().includes(textoBusqueda)));
                                            });

                                            // Luego aplicar los otros filtros (checkbox y precio)
                                            aplicarFiltros();
                                        }

                                        // Función para actualizar el precio mostrado y aplicar filtros
                                        function actualizarPrecio(valor) {
                                            document.getElementById('precioActual').innerText = 'S/ ' + valor;
                                            aplicarFiltros();
                                        }

                                        // Inicialización al cargar el DOM
                                        document.addEventListener('DOMContentLoaded', function() {
                                            // Cargar espacios iniciales
                                            aplicarFiltros();

                                            // Agregar listeners a todos los filtros
                                            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                                            checkboxes.forEach(checkbox => {
                                                checkbox.addEventListener('change', aplicarFiltros);
                                            });

                                            // Listener para el slider de precio
                                            const precioSlider = document.getElementById('precioRange');
                                            if (precioSlider) {
                                                precioSlider.addEventListener('input', function() {
                                                    document.getElementById('precioActual').innerText = 'S/ ' + this.value;
                                                    // Aplicar filtros con debounce para mejor rendimiento
                                                    clearTimeout(window.filtroTimeout);
                                                    window.filtroTimeout = setTimeout(aplicarFiltros, 300);
                                                });
                                            }

                                            // Listener para búsqueda con debounce
                                            const campoBusqueda = document.querySelector('.search-box input');
                                            if (campoBusqueda) {
                                                campoBusqueda.addEventListener('input', function() {
                                                    clearTimeout(window.busquedaTimeout);
                                                    window.busquedaTimeout = setTimeout(aplicarFiltros, 500);
                                                });
                                            }

                                            // Listener para filtros de rating
                                            const radiosRating = document.querySelectorAll('input[name="rating"]');
                                            radiosRating.forEach(radio => {
                                                radio.addEventListener('change', aplicarFiltros);
                                            });
                                            // Corregir los acordeones para que funcionen independientemente
                                            const accordionBtns = document.querySelectorAll('.accordion-button');

                                            accordionBtns.forEach(btn => {
                                                btn.addEventListener('click', function(e) {
                                                    e.preventDefault();

                                                    // Obtener el contenido del acordeón objetivo
                                                    const target = document.querySelector(this.getAttribute('data-bs-target'));

                                                    // Alternar la clase 'show' para el contenido
                                                    if (target) {
                                                        target.classList.toggle('show');
                                                        // Alternar el estado expanded del botón
                                                        this.setAttribute('aria-expanded',
                                                            this.getAttribute('aria-expanded') === 'true' ? 'false' : 'true');

                                                        // Alternar la clase collapsed en el botón
                                                        this.classList.toggle('collapsed');
                                                    }
                                                });
                                            });

                                            // 2. Inicializar el rango de precio en su valor máximo
                                            const precioRange = document.getElementById('precioRange');
                                            if (precioRange) {
                                                precioRange.value = 150; // Establecer al máximo
                                                document.getElementById('precioActual').innerText = 'S/ 150';
                                            }

                                            // Asegurarse de que los espacios estáticos son visibles inicialmente
                                            document.getElementById('espacios-estaticos').style.display = 'flex';
                                            document.getElementById('tarjetas-container').style.display = 'none';

                                            // Añadir estilos para forzar que la paginación sea horizontal
                                            const style = document.createElement('style');
                                            style.textContent = `
                                                .pagination-container {
                                                    display: flex !important;
                                                    flex-direction: row !important;
                                                    justify-content: center !important;
                                                }

                                                #pagination {
                                                    display: flex !important;
                                                    flex-direction: row !important;
                                                }

                                                /* Asegurar que los elementos de página se muestren en línea */
                                                .pagination-container .page-item {
                                                    display: inline-block !important;
                                                }
    `;
                                            document.head.appendChild(style);
                                        });
                                    </script>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- END layout-wrapper -->
<div class="sidebar-overlay"></div>
    <!-- JAVASCRIPT -->
    <script th:src="@{/assets/libs/jquery/jquery.min.js}"></script>
    <script th:src="@{/assets/libs/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/assets/libs/metismenu/metisMenu.min.js}"></script>
    <script th:src="@{/assets/libs/simplebar/simplebar.min.js}"></script>
    <script th:src="@{/assets/libs/node-waves/waves.min.js}"></script>

    <!-- apexcharts -->
    <script th:src="@{/assets/libs/apexcharts/apexcharts.min.js}"></script>

    <!-- jquery.vectormap map -->
    <script th:src="@{/assets/libs/admin-resources/jquery.vectormap/jquery-jvectormap-1.2.2.min.js}"></script>
    <script th:src="@{/assets/libs/admin-resources/jquery.vectormap/maps/jquery-jvectormap-us-merc-en.js}"></script>

    <!-- plugin js -->
    <script th:src="@{/assets/libs/moment/min/moment.min.js}"></script>
    <script th:src="@{/assets/libs/jquery-ui-dist/jquery-ui.min.js}"></script>
    <script th:src="@{/assets/libs/@fullcalendar/core/main.min.js}"></script>
    <script th:src="@{/assets/libs/@fullcalendar/bootstrap/main.min.js}"></script>
    <script th:src="@{/assets/libs/@fullcalendar/daygrid/main.min.js}"></script>
    <script th:src="@{/assets/libs/@fullcalendar/timegrid/main.min.js}"></script>
    <script th:src="@{/assets/libs/@fullcalendar/interaction/main.min.js}"></script>

    <!-- Required datatable js -->
    <script th:src="@{/assets/libs/datatables.net/js/jquery.dataTables.min.js}"></script>
    <script th:src="@{/assets/libs/datatables.net-bs4/js/dataTables.bootstrap4.min.js}"></script>

    <!-- Responsive examples -->
    <script th:src="@{/assets/libs/datatables.net-responsive/js/dataTables.responsive.min.js}"></script>
    <script th:src="@{/assets/libs/datatables.net-responsive-bs4/js/responsive.bootstrap4.min.js}"></script>
    <script th:src="@{/assets/js/app.js}"></script>

</body>
</html>
